{% extends "base.html" %}
{% block content %}

<h2 class="pos-title">ðŸ§¾ Pedido #{{ pedido.id }}</h2>

<div class="pedido-header">
    <div class="pedido-info">
        <div><strong>Estado:</strong> {{ pedido.estado }}</div>
        <div><strong>Total:</strong> {{ pedido.total | money }}</div>
    </div>

    <div class="pedido-actions">
        <button type="button"
                class="btn-primary"
                onclick="abrirTicketPreview({{ pedido.id }})">
            ðŸ§¾ Ver ticket
        </button>

        {% if pedido.estado == 'abierto' %}
        <button type="button"
                class="btn-warning"
                onclick="abrirCerrarPedido()">
            âœ… Cerrar pedido
        </button>
        {% endif %}
    </div>
</div>

<div class="pos-layout">

    <!-- ================== PANEL IZQUIERDO ================== -->
    <section class="pos-left">

        <!-- ================== ITEMS DEL PEDIDO ================== -->
        <div class="card">
            <div class="card-head">
                <h3>Productos en el pedido</h3>
            </div>

            {% if items %}
            <table class="pedido-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cant.</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for it in items %}
                    <tr>
                        <td class="td-left">{{ it.nombre }}</td>
                        <td>{{ it.cantidad }}</td>
                        <td>{{ it.precio_unitario | money }}</td>
                        <td><strong>{{ it.subtotal | money }}</strong></td>
                        <td>
                            {% if pedido.estado == 'abierto' %}
                            <form method="post"
                                  action="{{ url_for('eliminar_item_pedido',
                                                      pedido_id=pedido.id,
                                                      item_id=it.id) }}"
                                  onsubmit="return confirm('Â¿Eliminar este producto?')">
                                <button type="submit" class="btn-red">âœ•</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No hay productos aÃºn.</p>
            {% endif %}
        </div>

        <!-- ================== AGREGAR MÃS ================== -->
        {% if pedido.estado == 'abierto' %}
        <div class="card">
            <div class="card-head">
                <h3>Agregar productos</h3>
                <span class="hint">Toca para sumar</span>
            </div>

            <div class="productos-grid">
                {% for p in productos %}
                <button type="button"
                        class="producto-card"
                        onclick="agregarProducto('{{ p.id }}','{{ p.nombre }}',{{ p.precio }})">
                    <div class="producto-nombre">{{ p.nombre }}</div>
                    <div class="producto-meta">
                        <span class="categoria">{{ p.categoria }}</span>
                        <span class="precio">{{ p.precio | money }}</span>
                    </div>
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </section>

    <!-- ================== PANEL DERECHO ================== -->
    {% if pedido.estado == 'abierto' %}
    <aside class="pos-right">

        <div class="card card-sticky">

            <div class="card-head">
                <h3>Carrito nuevo</h3>
            </div>

            <!-- ðŸ‘‡ FORM CORRECTAMENTE ENVOLVIENDO LOS INPUTS -->
            <form method="post">

                <table id="carritoTable">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div class="total-box">
                    <div>Total agregado</div>
                    <div class="total-amount" id="totalPedido">$0.00</div>
                </div>

                <!-- ðŸ”¥ AHORA SÃ VIAJA EN EL POST -->
                <div id="inputsHidden"></div>

                <button type="submit" class="btn-guardar">
                    âž• Agregar al pedido
                </button>

            </form>

        </div>

    </aside>
    {% endif %}

</div>

<!-- ================== MODAL TICKET ================== -->
<div id="ticketModal" class="modal">
    <div class="modal-box monospace">

        <button class="modal-close" onclick="cerrarTicketModal()">âœ•</button>

        <h3>Preview del ticket</h3>

        <pre id="ticketTexto" class="ticket-preview"></pre>

        <a id="btnWhatsapp"
           target="_blank"
           class="btn-whatsapp">
            ðŸ“² Enviar por WhatsApp
        </a>
    </div>
</div>

<!-- ================== MODAL CERRAR PEDIDO ================== -->
<div id="cerrarModal" class="modal">
    <div class="modal-box">

        <button class="modal-close" onclick="cerrarCerrarModal()">âœ•</button>

        <h3>Cerrar pedido</h3>

        <label>NÃºmero WhatsApp (opcional)</label>
        <input type="text" id="telefonoWhatsapp"
               placeholder="5214491234567">

        <p class="hint">
            Si ingresas un nÃºmero, se enviarÃ¡ el ticket.
        </p>

        <div class="modal-actions">
            <form method="post"
                  action="{{ url_for('cerrar_pedido', pedido_id=pedido.id) }}">
                <button type="submit" class="btn-gray">
                    Cerrar sin enviar
                </button>
            </form>

            <button type="button"
                    class="btn-whatsapp"
                    onclick="cerrarYEnviar()">
                Cerrar y enviar
            </button>
        </div>
    </div>
</div>

<!-- ================== SCRIPT ================== -->
<script>
let carrito = {};

function agregarProducto(id, nombre, precio) {
    if (!carrito[id]) carrito[id] = { nombre, precio, cantidad: 1 };
    else carrito[id].cantidad++;
    renderCarrito();
}

function restarProducto(id) {
    carrito[id].cantidad--;
    if (carrito[id].cantidad <= 0) delete carrito[id];
    renderCarrito();
}

function eliminarProducto(id) {
    delete carrito[id];
    renderCarrito();
}

function renderCarrito() {
    const tbody = document.querySelector("#carritoTable tbody");
    const hidden = document.getElementById("inputsHidden");
    tbody.innerHTML = "";
    hidden.innerHTML = "";

    let total = 0;

    for (const id in carrito) {
        const it = carrito[id];
        const subtotal = it.precio * it.cantidad;
        total += subtotal;

        tbody.innerHTML += `
            <tr>
                <td class="td-left">${it.nombre}</td>
                <td>
                    <button type="button" onclick="restarProducto('${id}')">â€“</button>
                    ${it.cantidad}
                    <button type="button" onclick="agregarProducto('${id}','${it.nombre}',${it.precio})">+</button>
                </td>
                <td>$${it.precio.toFixed(2)}</td>
                <td><strong>$${subtotal.toFixed(2)}</strong></td>
                <td><button type="button" onclick="eliminarProducto('${id}')">âœ•</button></td>
            </tr>
        `;

        hidden.innerHTML += `
            <input type="hidden" name="producto_id[]" value="${id}">
            <input type="hidden" name="cantidad[]" value="${it.cantidad}">
        `;
    }

    document.getElementById("totalPedido").innerText = `$${total.toFixed(2)}`;
}

/* ===== MODALES ===== */
function abrirTicketPreview(id) {
    fetch(`/pedido/${id}/ticket_preview`)
        .then(r => r.json())
        .then(d => {
            document.getElementById("ticketTexto").innerText = d.texto;
            document.getElementById("btnWhatsapp").href = d.whatsapp_url;
            document.getElementById("ticketModal").style.display = "flex";
        });
}
function cerrarTicketModal() {
    document.getElementById("ticketModal").style.display = "none";
}
function abrirCerrarPedido() {
    document.getElementById("cerrarModal").style.display = "flex";
}
function cerrarCerrarModal() {
    document.getElementById("cerrarModal").style.display = "none";
}
function cerrarYEnviar() {
    const tel = document.getElementById("telefonoWhatsapp").value;
    if (!tel) return alert("Ingresa un nÃºmero");

    window.open(`/pedido/{{ pedido.id }}/whatsapp?tel=${tel}`, "_blank");
    fetch(`/cerrar_pedido/{{ pedido.id }}`, { method: "POST" })
        .then(() => location.href = "/pedidos_abiertos");
}
</script>

{% endblock %}
