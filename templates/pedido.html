{% extends "base.html" %}

{% block content %}

<h2>Pedido #{{ pedido.id }}</h2>

<p>
    Estado: <strong>{{ pedido.estado }}</strong><br>
    Total actual: <strong>{{ pedido.total | money }}</strong>
</p>

<div style="display:flex; gap:10px; margin-bottom:10px;">
    <button type="button"
            onclick="abrirTicketPreview({{ pedido.id }})"
            style="background:#333;color:white;padding:8px;border-radius:6px;">
        üßæ Ver ticket
    </button>

    {% if pedido.estado == 'abierto' %}
    <button type="button"
            onclick="abrirCerrarPedido()"
            style="background:#e67e22;color:white;padding:8px;border-radius:6px;">
        ‚úÖ Cerrar pedido
    </button>
    {% endif %}
</div>

<hr>

<h3>Productos en el pedido</h3>

{% if items %}
<table border="1" cellpadding="6" cellspacing="0">
    <thead>
        <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Subtotal</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for it in items %}
        <tr>
            <td>{{ it.nombre }}</td>
            <td>{{ it.cantidad }}</td>
            <td>{{ it.precio_unitario | money }}</td>
            <td>{{ it.subtotal | money }}</td>
            <td>
                {% if pedido.estado == 'abierto' %}
                <form method="post"
                      action="{{ url_for('eliminar_item_pedido',
                                          pedido_id=pedido.id,
                                          item_id=it.id) }}"
                      onsubmit="return confirm('¬øEliminar este producto?')">
                    <button type="submit">‚ùå</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No hay productos a√∫n.</p>
{% endif %}

<hr>

<h3>Agregar m√°s productos</h3>

<form method="post">

    <div style="display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap:10px;">
        {% for p in productos %}
        <button type="button"
                onclick="agregarProducto('{{ p.id }}','{{ p.nombre }}',{{ p.precio }})">
            {{ p.nombre }}<br>
            {{ p.precio | money }}
        </button>
        {% endfor %}
    </div>

    <hr>

    <table id="carritoTable" border="1" cellpadding="6">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cant</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="inputsHidden"></div>

    <br>
    <button type="submit">Agregar al pedido</button>
</form>

<!-- ================== MODAL TICKET ================== -->
<div id="ticketModal"
     style="display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.6);
            align-items:center; justify-content:center; z-index:999;">

    <div style="background:white; padding:20px; width:320px;
                border-radius:10px; font-family:monospace;">

        <h3 style="text-align:center;">Preview del ticket</h3>

        <pre id="ticketTexto"
             style="background:#f4f4f4; padding:12px;
                    white-space:pre-wrap; font-size:14px;"></pre>

        <div style="display:flex; gap:10px; margin-top:12px;">
            <a id="btnWhatsapp"
               target="_blank"
               style="flex:1; background:#25D366; color:white;
                      text-align:center; padding:8px;
                      border-radius:6px; text-decoration:none;">
                üì≤ Enviar
            </a>

            <button type="button"
                    onclick="cerrarTicketModal()"
                    style="flex:1;">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- ================== MODAL CERRAR PEDIDO ================== -->
<div id="cerrarModal"
     style="display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.6);
            align-items:center; justify-content:center; z-index:999;">

    <div style="background:white; padding:20px; width:320px;
                border-radius:10px;">

        <h3>Cerrar pedido</h3>

        <label>N√∫mero de WhatsApp (opcional)</label>
        <input type="text" id="telefonoWhatsapp"
               placeholder="Ej: 5214491234567"
               style="width:100%; padding:6px; margin-top:4px;">

        <p style="font-size:12px;color:#666;">
            Si ingresas un n√∫mero, se enviar√° el ticket por WhatsApp.
        </p>

        <div style="display:flex; gap:10px; margin-top:12px;">
            <form method="post"
                  action="{{ url_for('cerrar_pedido', pedido_id=pedido.id) }}">
                <button type="submit">Cerrar sin enviar</button>
            </form>

            <button type="button"
                    onclick="cerrarYEnviar()"
                    style="background:#25D366;color:white;">
                Cerrar y enviar
            </button>
        </div>
    </div>
</div>

<!-- ================== SCRIPTS ================== -->
<script>
let carrito = {};

function agregarProducto(id, nombre, precio) {
    if (!carrito[id]) {
        carrito[id] = { nombre, precio, cantidad: 1 };
    } else {
        carrito[id].cantidad += 1;
    }
    renderCarrito();
}

function restarProducto(id) {
    carrito[id].cantidad--;
    if (carrito[id].cantidad <= 0) delete carrito[id];
    renderCarrito();
}

function eliminarProducto(id) {
    delete carrito[id];
    renderCarrito();
}

function renderCarrito() {
    const tbody = document.querySelector("#carritoTable tbody");
    const hidden = document.getElementById("inputsHidden");
    tbody.innerHTML = "";
    hidden.innerHTML = "";

    for (const id in carrito) {
        const it = carrito[id];
        tbody.innerHTML += `
            <tr>
                <td>${it.nombre}</td>
                <td>
                    <button type="button" onclick="restarProducto('${id}')">-</button>
                    ${it.cantidad}
                    <button type="button" onclick="agregarProducto('${id}','${it.nombre}',${it.precio})">+</button>
                </td>
                <td>$${it.precio.toFixed(2)}</td>
                <td>$${(it.precio * it.cantidad).toFixed(2)}</td>
                <td>
                    <button type="button" onclick="eliminarProducto('${id}')">X</button>
                </td>
            </tr>
        `;

        hidden.innerHTML += `
            <input type="hidden" name="producto_id[]" value="${id}">
            <input type="hidden" name="cantidad[]" value="${it.cantidad}">
        `;
    }
}

function abrirTicketPreview(pedidoId) {
    fetch(`/pedido/${pedidoId}/ticket_preview`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("ticketTexto").innerText = data.texto;
            document.getElementById("btnWhatsapp").href = data.whatsapp_url;
            document.getElementById("ticketModal").style.display = "flex";
        });
}

function cerrarTicketModal() {
    document.getElementById("ticketModal").style.display = "none";
}

function abrirCerrarPedido() {
    document.getElementById("cerrarModal").style.display = "flex";
}

function cerrarYEnviar() {
    const tel = document.getElementById("telefonoWhatsapp").value;
    if (!tel) {
        alert("Ingresa un n√∫mero o usa 'Cerrar sin enviar'");
        return;
    }

    window.open(`/pedido/{{ pedido.id }}/whatsapp?tel=${tel}`, "_blank");

    fetch(`/cerrar_pedido/{{ pedido.id }}`, { method: "POST" })
        .then(() => location.href = "/pedidos_abiertos");
}
</script>

{% endblock %}
