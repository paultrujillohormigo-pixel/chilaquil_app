{% extends "base.html" %}
{% block content %}

<h2 class="pos-title">üßæ Pedido #{{ pedido.id }}</h2>

<div class="pedido-header">
  <div class="pedido-info">
    <div><strong>Estado:</strong> {{ pedido.estado }}</div>
    <div><strong>Total:</strong> {{ pedido.total | money }}</div>
    {% if pedido.telefono_whatsapp %}
      <div><strong>WhatsApp:</strong> {{ pedido.telefono_whatsapp }}</div>
    {% else %}
      <div class="hint">WhatsApp: ‚Äî</div>
    {% endif %}
  </div>

  <div class="pedido-actions">
    <button type="button" class="btn-primary" onclick="abrirTicketPreview({{ pedido.id }})">
      üßæ Ver ticket
    </button>

    {% if pedido.estado == 'abierto' %}
      <form method="post" action="{{ url_for('cerrar_pedido', pedido_id=pedido.id) }}" style="display:inline;">
        <button type="submit" class="btn-gray" onclick="return confirm('¬øCerrar pedido sin enviar WhatsApp?')">
          ‚úÖ Cerrar (sin enviar)
        </button>
      </form>

      <form method="post"
            action="{{ url_for('cerrar_pedido_whatsapp', pedido_id=pedido.id) }}"
            style="display:inline;">
        <button type="submit"
                class="btn-whatsapp"
                onclick="return confirmarCerrarWhatsApp();">
          üì≤ Cerrar y mandar WhatsApp + Totopos
        </button>
      </form>
    {% endif %}
  </div>
</div>

<div class="pos-layout">

  <section class="pos-left">

    <div class="card">
      <div class="card-head">
        <h3>Productos en el pedido</h3>
      </div>

      {% if items %}
      <table class="pedido-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td class="td-left">
              {{ it.nombre }}

              {% if it.proteina or it.sin or it.nota %}
              <div class="cocina-meta">
                {% if it.proteina %}
                <div><span class="tag">PROT: {{ it.proteina }}</span></div>
                {% endif %}
                {% if it.sin %}
                <div><span class="tag tag-warn">SIN: {{ it.sin }}</span></div>
                {% endif %}
                {% if it.nota %}
                <div class="nota"><strong>NOTA:</strong> {{ it.nota }}</div>
                {% endif %}
              </div>
              {% endif %}
            </td>
            <td>{{ it.cantidad }}</td>
            <td>{{ it.precio_unitario | money }}</td>
            <td><strong>{{ it.subtotal | money }}</strong></td>
            <td>
              {% if pedido.estado == 'abierto' %}
              <form method="post"
                    action="{{ url_for('eliminar_item_pedido', pedido_id=pedido.id, item_id=it.id) }}"
                    onsubmit="return confirm('¬øEliminar este producto?')">
                <button type="submit" class="btn-red">‚úï</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No hay productos a√∫n.</p>
      {% endif %}
    </div>

    {% if pedido.estado == 'abierto' %}
    <div class="card">
      <div class="card-head">
        <h3>Agregar productos</h3>
        <span class="hint">Toca para sumar</span>
      </div>

      <div class="productos-grid">
        {% for p in productos %}
        <button type="button"
                class="producto-card"
                onclick='agregarProducto("{{ p.id }}", {{ p.nombre|tojson }}, {{ p.precio }}, {{ (p.categoria or "")|tojson }})'>
          <div class="producto-nombre">{{ p.nombre }}</div>
          <div class="producto-meta">
            <span class="categoria">{{ p.categoria }}</span>
            <span class="precio">{{ p.precio | money }}</span>
          </div>
        </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </section>

  {% if pedido.estado == 'abierto' %}
  <aside class="pos-right">

    <div class="card card-sticky">

      <div class="card-head carrito-head">
        <h3 style="margin:0;">Carrito nuevo</h3>
        <button type="button" class="btn-gray" onclick="abrirVistaCocina()">üë®‚Äçüç≥ Vista cocina</button>
      </div>

      <form method="post">
        <table id="carritoTable">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="total-box">
          <div>Total agregado</div>
          <div class="total-amount" id="totalPedido">$0.00</div>
        </div>

        <div id="inputsHidden"></div>

        <button type="submit" class="btn-guardar">
          ‚ûï Agregar al pedido
        </button>
      </form>

    </div>

  </aside>
  {% endif %}

</div>

<!-- ================== MODAL TICKET ================== -->
<div id="ticketModal" class="modal">
  <div class="modal-box monospace">
    <button type="button" class="modal-close" onclick="cerrarTicketModal()">‚úï</button>
    <h3>Preview del ticket</h3>
    <pre id="ticketTexto" class="ticket-preview"></pre>

    <a id="btnWhatsapp" target="_blank" class="btn-whatsapp">
      üì≤ Enviar por WhatsApp
    </a>
  </div>
</div>

<!-- ================== MODAL PERSONALIZACI√ìN ================== -->
<div id="customModal" class="modal">
  <div class="modal-box">
    <button type="button" class="modal-close" onclick="cerrarCustomModal()">‚úï</button>

    <h3>Personalizar</h3>
    <p class="hint" id="customProductoNombre" style="margin-top:-8px;"></p>

    <!-- ‚úÖ Salsa (opcional). Se guarda salsa_id para reporte; NO descuenta stock si tu insumo salsa est√° en descuenta_stock=0 -->
    <div class="custom-section">
      <label><strong>Salsa</strong></label>
      <div id="salsaRadios" class="custom-grid"></div>
    </div>

    <div class="custom-section">
      <label><strong>Prote√≠na</strong></label>
      <div id="proteinaRadios" class="custom-grid"></div>
    </div>

    <div class="custom-section">
      <label><strong>Quitar</strong></label>
      <div id="sinChecks" class="custom-grid"></div>
      <p class="hint" style="margin:6px 0 0;">D√©jalo vac√≠o si va normal.</p>
    </div>

    <div class="custom-section">
      <label><strong>Notas</strong></label>
      <textarea id="notaInput" rows="3" style="width:100%;" placeholder="Ej. salsa aparte, bien dorados, etc."></textarea>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-gray" onclick="cerrarCustomModal()">Cancelar</button>
      <button type="button" class="btn-primary" onclick="confirmarCustom()">Agregar</button>
    </div>
  </div>
</div>

<!-- ================== VISTA COCINA (OVERLAY) ================== -->
<div id="cocinaModal" class="modal">
  <div class="modal-box">
    <button type="button" class="modal-close" onclick="cerrarVistaCocina()">‚úï</button>

    <h3>Comanda (Vista cocina)</h3>
    <p class="hint">Pedido #{{ pedido.id }}</p>

    <div id="cocinaBody"></div>

    <div class="modal-actions">
      <button type="button" class="btn-gray" onclick="window.print()">Imprimir</button>
      <button type="button" class="btn-primary" onclick="cerrarVistaCocina()">Cerrar</button>
    </div>
  </div>
</div>

<style>
@media (max-width: 1100px){
  .pos-layout{display:flex;flex-direction:column;gap:12px;}
  .pos-left,.pos-right{ width:100%; }
  .card-sticky{ position:static !important; top:auto !important; }
}
.pos-layout, .card, .carrito-wrap, #carritoTable, .modal-box{ max-width:100%; }
body{ overflow-x:hidden; }
#carritoTable, .pedido-table{ width:100%; table-layout:fixed; }
#carritoTable th,#carritoTable td,.pedido-table th,.pedido-table td{ overflow:hidden;text-overflow:ellipsis;vertical-align:top; }
#carritoTable td.td-left,#carritoTable td:first-child,.pedido-table td.td-left,.pedido-table td:first-child{
  white-space:normal;overflow-wrap:anywhere;word-break:break-word;
}
.carrito-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
.cocina-meta{ margin-top:6px; display:flex; flex-direction:column; gap:6px; }
.tag{
  display:inline-block;padding:4px 8px;border-radius:8px;background:#f3f3f3;border:1px solid #ddd;
  font-weight:700;font-size:.85rem;max-width:100%;overflow-wrap:anywhere;word-break:break-word;
}
.tag-warn{ background:#fff3cd; border-color:#f0c36d; }
.nota{
  padding:6px 8px;border-radius:8px;border:1px dashed #bbb;background:#fff;font-size:.85rem;
  max-width:100%;overflow-wrap:anywhere;word-break:break-word;
}
.custom-section{ margin-top:12px; }
.custom-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px; }
.custom-pill{ border:1px solid #ddd; border-radius:12px; padding:12px; display:flex; gap:10px; align-items:center; }
@media (max-width: 1100px){ .custom-grid{ grid-template-columns:1fr; } }
.modal{
  position:fixed;left:0;top:0;width:100vw;height:100vh;height:100dvh;display:none;justify-content:center;align-items:center;
  background:rgba(0,0,0,.45);z-index:2147483647;padding:14px;box-sizing:border-box;overscroll-behavior:contain;
}
.modal.is-open{ display:flex; }
.modal-box{
  background:#fff;border-radius:14px;padding:16px;width:min(640px, 94vw);
  max-height: calc(var(--vh, 1vh) * 88);overflow:auto;-webkit-overflow-scrolling:touch;transform: translateZ(0);
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
@media (max-width: 1100px){
  .modal{ align-items:flex-end; padding:10px; }
  .modal-box{ width:100%; border-radius:18px 18px 14px 14px; max-height: calc(var(--vh, 1vh) * 92); }
}
.modal-close{
  position:sticky;top:0;float:right;border:0;background:rgba(255,255,255,.88);backdrop-filter: blur(6px);
  font-size:18px;cursor:pointer;padding:6px 10px;border-radius:10px;
}
.modal-box input, .modal-box textarea, .modal-box select{ font-size:16px; }
.modal-actions{
  position:sticky;bottom:0;background: rgba(255,255,255,.92);backdrop-filter: blur(6px);
  padding-top:10px;display:flex;gap:10px;justify-content:flex-end;
}
</style>

<script>
function setVH(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVH();
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', setVH);

function confirmarCerrarWhatsApp(){
  const tel = "{{ (pedido.telefono_whatsapp or '')|e }}";
  if (!tel){
    alert("Este pedido no tiene WhatsApp. Agrega el tel√©fono al crear el pedido.");
    return false;
  }
  return confirm("¬øCerrar pedido y mandar WhatsApp con ticket + totopos?");
}

/* ====== Datos desde backend (para mapear a ID) ====== */
const PROTEINAS_DB = {{ (proteinas or [])|tojson }};
const SALSAS_DB = {{ (salsas or [])|tojson }};

function mapIdByNombre(arr, nombre){
  const n = (nombre || "").toString().trim().toLowerCase();
  for (const it of (arr || [])){
    if ((it.nombre || "").toString().trim().toLowerCase() === n){
      return it.id;
    }
  }
  return null;
}

/* ====== Config modificadores UI ====== */
const PROTEINAS = ["Pollo","Arrachera","Chorizo","Cochinita","Huevo","Sin prote√≠na"];
const SIN_OPCIONES = ["Cebolla","Crema","Queso","Aguacate"];

/* NO personalizar en bebidas/extras */
const NO_MOD_CATEGORIAS = ["bebidas", "bebida", "extras", "extra", "complementos", "postres"];
const NO_MOD_KEYWORDS = ["coca","refresco","agua","caf√©","cafe","chai","capuccino","capuchino","jugo","jarrito","boing"];

function normaliza(str){ return (str || "").toString().trim().toLowerCase(); }

function productoTieneModificadores(nombre, categoria){
  const cat = normaliza(categoria);
  const nom = normaliza(nombre);
  if (NO_MOD_CATEGORIAS.includes(cat)) return false;
  for (const c of NO_MOD_CATEGORIAS){ if (cat.includes(c)) return false; }
  for (const kw of NO_MOD_KEYWORDS){ if (nom.includes(kw)) return false; }
  return true;
}

let carrito = {};
let modalState = { producto_id:null, nombre:"", precio:0, uid:null };

function escapeHtml(str){
  const s = String(str ?? "");
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function uidLinea(producto_id){
  return String(producto_id) + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
}

/* Agregar producto */
function agregarProducto(producto_id, nombre, precio, categoria){
  const uid = uidLinea(producto_id);

  // si NO aplica modal
  if (!productoTieneModificadores(nombre, categoria)){
    carrito[uid] = {
      producto_id, nombre, precio: Number(precio), cantidad: 1,
      custom: { salsa: "", salsa_id: null, proteina: "", proteina_id: null, sin: [], nota: "" }
    };
    renderCarrito();
    return;
  }

  modalState = { producto_id, nombre, precio: Number(precio), uid };
  abrirCustomModal();
}

/* Modal */
function abrirCustomModal(){
  setVH();
  document.getElementById("customProductoNombre").innerText = modalState.nombre;

  // salsas
  const salsaRadios = document.getElementById("salsaRadios");
  salsaRadios.innerHTML = "";
  // opci√≥n "‚Äî"
  salsaRadios.innerHTML +=
    '<label class="custom-pill">' +
      '<input type="radio" name="salsa_radio" value="" checked>' +
      '<span>‚Äî</span>' +
    '</label>';
  (SALSAS_DB || []).forEach((s) => {
    salsaRadios.innerHTML +=
      '<label class="custom-pill">' +
        '<input type="radio" name="salsa_radio" value="' + escapeHtml(s.nombre) + '">' +
        '<span>' + escapeHtml(s.nombre) + '</span>' +
      '</label>';
  });

  // prote√≠nas
  const radios = document.getElementById("proteinaRadios");
  radios.innerHTML = "";
  PROTEINAS.forEach((p, idx) => {
    radios.innerHTML +=
      '<label class="custom-pill">' +
        '<input type="radio" name="proteina_radio" value="' + escapeHtml(p) + '" ' + (idx===0 ? 'checked' : '') + '>' +
        '<span>' + escapeHtml(p) + '</span>' +
      '</label>';
  });

  // sin
  const checks = document.getElementById("sinChecks");
  checks.innerHTML = "";
  SIN_OPCIONES.forEach((s) => {
    checks.innerHTML +=
      '<label class="custom-pill">' +
        '<input type="checkbox" name="sin_check" value="' + escapeHtml(s) + '">' +
        '<span>Sin ' + escapeHtml(s) + '</span>' +
      '</label>';
  });

  document.getElementById("notaInput").value = "";

  document.body.style.overflow = "hidden";
  document.getElementById("customModal").classList.add("is-open");
}

function cerrarCustomModal(){
  document.getElementById("customModal").classList.remove("is-open");
  document.body.style.overflow = "";
  modalState = { producto_id:null, nombre:"", precio:0, uid:null };
}

function confirmarCustom(){
  const salsaEl = document.querySelector("input[name='salsa_radio']:checked");
  const salsa = salsaEl ? (salsaEl.value || "") : "";
  const salsa_id = salsa ? mapIdByNombre(SALSAS_DB, salsa) : null;

  const protEl = document.querySelector("input[name='proteina_radio']:checked");
  const proteina = protEl ? (protEl.value || "") : "";
  const proteina_id = proteina ? mapIdByNombre(PROTEINAS_DB, proteina) : null;

  const sin = [];
  document.querySelectorAll("input[name='sin_check']:checked").forEach(x => sin.push(x.value));
  const nota = document.getElementById("notaInput").value || "";

  const uid = modalState.uid;

  carrito[uid] = {
    producto_id: modalState.producto_id,
    nombre: modalState.nombre,
    precio: Number(modalState.precio),
    cantidad: 1,
    custom: { salsa, salsa_id, proteina, proteina_id, sin, nota }
  };

  cerrarCustomModal();
  renderCarrito();
}

/* Carrito controls */
function restarProducto(uid){
  if (!carrito[uid]) return;
  carrito[uid].cantidad -= 1;
  if (carrito[uid].cantidad <= 0) delete carrito[uid];
  renderCarrito();
}
function sumarProducto(uid){
  if (!carrito[uid]) return;
  carrito[uid].cantidad += 1;
  renderCarrito();
}
function eliminarProducto(uid){
  delete carrito[uid];
  renderCarrito();
}
function editarLinea(uid){
  const it = carrito[uid];
  if (!it) return;
  modalState = { producto_id: it.producto_id, nombre: it.nombre, precio: it.precio, uid };
  abrirCustomModal();

  // set salsa y prot actuales
  const targetSalsa = (it.custom && it.custom.salsa) ? it.custom.salsa : "";
  document.querySelectorAll("input[name='salsa_radio']").forEach(r => r.checked = (r.value === targetSalsa));

  const targetProt = (it.custom && it.custom.proteina) ? it.custom.proteina : "";
  const protRadios = document.querySelectorAll("input[name='proteina_radio']");
  protRadios.forEach((r, idx) => {
    r.checked = (r.value === targetProt) || (!targetProt && idx === 0);
  });

  const setSin = new Set((it.custom && it.custom.sin) ? it.custom.sin : []);
  document.querySelectorAll("input[name='sin_check']").forEach(c => c.checked = setSin.has(c.value));
  document.getElementById("notaInput").value = (it.custom && it.custom.nota) ? it.custom.nota : "";
}

/* Render + hidden inputs */
function renderCarrito(){
  const tbody = document.querySelector("#carritoTable tbody");
  const hidden = document.getElementById("inputsHidden");
  tbody.innerHTML = "";
  hidden.innerHTML = "";

  let total = 0;

  Object.keys(carrito).forEach(uid => {
    const it = carrito[uid];
    const subtotal = Number(it.precio) * Number(it.cantidad);
    total += subtotal;

    const salsa = (it.custom && it.custom.salsa) ? ("SALSA: " + it.custom.salsa) : "";
    const prot  = (it.custom && it.custom.proteina) ? ("PROT: " + it.custom.proteina) : "";
    const sin   = (it.custom && it.custom.sin && it.custom.sin.length) ? ("SIN: " + it.custom.sin.join(", ")) : "";
    const nota  = (it.custom && it.custom.nota && it.custom.nota.trim()) ? it.custom.nota.trim() : "";

    let cocinaHtml = "";
    if (salsa || prot || sin || nota){
      cocinaHtml += '<div class="cocina-meta">';
      if (salsa) cocinaHtml += '<div><span class="tag">' + escapeHtml(salsa) + '</span></div>';
      if (prot)  cocinaHtml += '<div><span class="tag">' + escapeHtml(prot) + '</span></div>';
      if (sin)   cocinaHtml += '<div><span class="tag tag-warn">' + escapeHtml(sin) + '</span></div>';
      if (nota)  cocinaHtml += '<div class="nota"><strong>NOTA:</strong> ' + escapeHtml(nota) + '</div>';
      cocinaHtml += '</div>';
    }

    tbody.innerHTML += `
      <tr>
        <td class="td-left">
          ${escapeHtml(it.nombre)}
          ${cocinaHtml}
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn-gray" onclick="editarLinea('${uid}')">Editar</button>
          </div>
        </td>

        <td>
          <div class="qty-controls" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center;">
            <button type="button" class="btn-gray" onclick="restarProducto('${uid}')">‚Äì</button>
            <span style="min-width:22px; text-align:center;">${it.cantidad}</span>
            <button type="button" class="btn-gray" onclick="sumarProducto('${uid}')">+</button>
          </div>
        </td>

        <td>$${Number(it.precio).toFixed(2)}</td>
        <td><strong>$${subtotal.toFixed(2)}</strong></td>
        <td><button type="button" class="btn-red" onclick="eliminarProducto('${uid}')">‚úï</button></td>
      </tr>
    `;

    const protTxt = it.custom ? (it.custom.proteina || "") : "";
    const sinTxt  = (it.custom && it.custom.sin) ? it.custom.sin.join(",") : "";
    const notaTxt = it.custom ? (it.custom.nota || "") : "";

    const protId  = (it.custom && it.custom.proteina_id) ? it.custom.proteina_id : "";
    const salsaId = (it.custom && it.custom.salsa_id) ? it.custom.salsa_id : "";

    hidden.innerHTML +=
      '<input type="hidden" name="producto_id[]" value="' + escapeHtml(it.producto_id) + '">' +
      '<input type="hidden" name="cantidad[]" value="' + escapeHtml(it.cantidad) + '">' +
      '<input type="hidden" name="proteina[]" value="' + escapeHtml(protTxt) + '">' +
      '<input type="hidden" name="sin[]" value="' + escapeHtml(sinTxt) + '">' +
      '<input type="hidden" name="nota[]" value="' + escapeHtml(notaTxt) + '">' +
      '<input type="hidden" name="proteina_id[]" value="' + escapeHtml(protId) + '">' +
      '<input type="hidden" name="salsa_id[]" value="' + escapeHtml(salsaId) + '">';
  });

  document.getElementById("totalPedido").innerText = "$" + total.toFixed(2);
}

/* Ticket */
function abrirTicketPreview(id){
  fetch(`/pedido/${id}/ticket_preview`)
    .then(r => r.json())
    .then(d => {
      document.getElementById("ticketTexto").innerText = d.texto;
      document.getElementById("btnWhatsapp").href = d.whatsapp_url;
      setVH();
      document.body.style.overflow = "hidden";
      document.getElementById("ticketModal").classList.add("is-open");
    });
}
function cerrarTicketModal(){
  document.getElementById("ticketModal").classList.remove("is-open");
  document.body.style.overflow = "";
}

/* Vista cocina */
function abrirVistaCocina(){
  const modal = document.getElementById("cocinaModal");
  const body = document.getElementById("cocinaBody");
  const uids = Object.keys(carrito);

  if (!uids.length){
    body.innerHTML = "<p>No hay productos nuevos en el carrito.</p>";
    setVH();
    document.body.style.overflow = "hidden";
    modal.classList.add("is-open");
    return;
  }

  let html = "";
  uids.forEach(uid => {
    const it = carrito[uid];
    const salsa = it.custom && it.custom.salsa ? ("SALSA: " + it.custom.salsa) : "SALSA: ‚Äî";
    const prot  = it.custom && it.custom.proteina ? ("PROT: " + it.custom.proteina) : "PROT: ‚Äî";
    const sin   = it.custom && it.custom.sin && it.custom.sin.length ? ("SIN: " + it.custom.sin.join(", ")) : "SIN: ‚Äî";
    const nota  = it.custom && it.custom.nota && it.custom.nota.trim() ? it.custom.nota.trim() : "";

    html +=
      '<div style="border:1px solid #ddd; border-radius:12px; padding:12px; margin-bottom:10px;">' +
        '<div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">' +
          '<div style="font-size:1.05rem; font-weight:900;">' + escapeHtml(it.nombre) + '</div>' +
          '<div style="font-size:1.05rem; font-weight:900;">x' + it.cantidad + '</div>' +
        '</div>' +
        '<div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">' +
          '<div><span class="tag">' + escapeHtml(salsa) + '</span></div>' +
          '<div><span class="tag">' + escapeHtml(prot) + '</span></div>' +
          '<div><span class="tag tag-warn">' + escapeHtml(sin) + '</span></div>' +
          (nota ? '<div class="nota"><strong>NOTA:</strong> ' + escapeHtml(nota) + '</div>' : "") +
        '</div>' +
      '</div>';
  });

  body.innerHTML = html;
  setVH();
  document.body.style.overflow = "hidden";
  modal.classList.add("is-open");
}
function cerrarVistaCocina(){
  document.getElementById("cocinaModal").classList.remove("is-open");
  document.body.style.overflow = "";
}

/* cerrar al click fuera */
document.addEventListener("click", (e) => {
  ["customModal","cocinaModal","ticketModal"].forEach(id => {
    const m = document.getElementById(id);
    if (m && m.classList.contains("is-open") && e.target === m){
      if (id === "customModal") cerrarCustomModal();
      if (id === "cocinaModal") cerrarVistaCocina();
      if (id === "ticketModal") cerrarTicketModal();
    }
  });
});
</script>

{% endblock %}
