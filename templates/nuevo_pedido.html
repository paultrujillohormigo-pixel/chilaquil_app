{% extends "base.html" %}
{% block content %}

<h2>Nuevo pedido</h2>

<form method="post" id="pedidoForm">

    <!-- ================== DATOS GENERALES ================== -->
    <label>Fecha del pedido:</label>
    <input type="datetime-local" name="fecha">
    <small>DÃ©jalo vacÃ­o para usar la fecha actual</small>
    <br><br>

    <label>Origen:</label>
    <select name="origen">
        <option value="mostrador">Mostrador</option>
        <option value="uber">Uber</option>
        <option value="didi">Didi</option>
        <option value="otro">Otro</option>
    </select>

    <label>Mesero:</label>
    <input type="text" name="mesero">

    <label>MÃ©todo de pago:</label>
    <select name="metodo_pago">
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
        <option value="transfer">Transfer</option>
        <option value="otro">Otro</option>
    </select>

    <label>Monto Uber (usa negativo para comisiÃ³n):</label>
    <input type="number" name="monto_uber" step="0.01" value="0">

    <hr>

    <!-- ================== PRODUCTOS ================== -->
    <h3>Productos</h3>

    <div class="productos-grid">
        {% for p in productos %}
        <div class="producto-card"
             onclick="agregarProducto('{{ p.id }}', '{{ p.nombre }}', {{ p.precio }})">
            <strong>{{ p.nombre }}</strong>
            <div>{{ p.categoria }}</div>
            <div class="precio">${{ p.precio }}</div>
        </div>
        {% endfor %}
    </div>

    <hr>

    <!-- ================== CARRITO ================== -->
    <h3>Carrito</h3>

    <table id="carritoTable">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cant.</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Total del Pedido: <span id="totalPedido">$0.00</span></h3>

    <!-- Inputs ocultos -->
    <div id="inputsHidden"></div>

    <button type="submit">Guardar pedido</button>
</form>

<!-- ================== ESTILOS ================== -->
<style>
.productos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
}

.producto-card {
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    background: #fafafa;
    transition: 0.2s;
    text-align: center;
}

.producto-card:hover {
    background: #f0f0f0;
    transform: scale(1.03);
}

#carritoTable {
    width: 100%;
    border-collapse: collapse;
}

#carritoTable th,
#carritoTable td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
}

.btn {
    padding: 4px 8px;
    cursor: pointer;
}

.btn-red {
    background: #e74c3c;
    color: white;
    border: none;
}

.btn-gray {
    background: #ddd;
    border: none;
}
</style>

<!-- ================== SCRIPT ================== -->
<script>
let carrito = {};

// âž• Agregar producto
function agregarProducto(id, nombre, precio) {
    if (!carrito[id]) {
        carrito[id] = {
            nombre,
            precio,
            cantidad: 1
        };
    } else {
        carrito[id].cantidad += 1;
    }
    renderCarrito();
}

// âž– Restar producto
function restarProducto(id) {
    if (!carrito[id]) return;

    carrito[id].cantidad -= 1;

    if (carrito[id].cantidad <= 0) {
        delete carrito[id];
    }

    renderCarrito();
}

// âŒ Eliminar producto
function eliminarProducto(id) {
    delete carrito[id];
    renderCarrito();
}

// ðŸ§  Render carrito + inputs
function renderCarrito() {
    const tbody = document.querySelector("#carritoTable tbody");
    const hidden = document.getElementById("inputsHidden");

    tbody.innerHTML = "";
    hidden.innerHTML = "";

    let total = 0;

    for (const id in carrito) {
        const item = carrito[id];
        const subtotal = item.precio * item.cantidad;
        total += subtotal;

        tbody.innerHTML += `
            <tr>
                <td>${item.nombre}</td>
                <td>
                    <button type="button" class="btn btn-gray" onclick="restarProducto('${id}')">â€“</button>
                    ${item.cantidad}
                    <button type="button" class="btn btn-gray" onclick="agregarProducto('${id}','${item.nombre}',${item.precio})">+</button>
                </td>
                <td>$${item.precio.toFixed(2)}</td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-red" onclick="eliminarProducto('${id}')">X</button>
                </td>
            </tr>
        `;

        hidden.innerHTML += `
            <input type="hidden" name="producto_id[]" value="${id}">
            <input type="hidden" name="cantidad[]" value="${item.cantidad}">
        `;
    }

    document.getElementById("totalPedido").innerText = `$${total.toFixed(2)}`;
}
</script>

{% endblock %}
