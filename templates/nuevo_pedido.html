{% extends "base.html" %}
{% block content %}

<h2 class="pos-title">üßæ Nuevo pedido</h2>

<form method="post" id="pedidoForm" class="pos-layout">

  <section class="pos-left">

    <div class="card">
      <div class="card-head">
        <h3>Datos del pedido</h3>
      </div>

      <div class="form-grid">

        <div>
          <label>Fecha</label>
          <input type="datetime-local" name="fecha">
          <small>Vac√≠o = ahora</small>
        </div>

        <div>
          <label>Origen</label>
          <select name="origen" id="origenSelect">
            <option value="mostrador">Mostrador</option>
            <option value="uber">Uber</option>
            <option value="didi">Didi</option>
            <option value="otro">Otro</option>
          </select>
        </div>

        <div>
          <label>Mesero</label>
          <input type="text" name="mesero" placeholder="Nombre">
        </div>

        <!-- ‚úÖ NUEVO: WhatsApp opcional -->
        <div>
          <label>WhatsApp (opcional)</label>
          <input type="tel" name="telefono_whatsapp" placeholder="4497419166" inputmode="numeric">
          <small>Si lo agregas, al cerrar se mandar√° ticket + totopos.</small>
        </div>

        <div>
          <label>M√©todo de pago</label>
          <select name="metodo_pago">
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
            <option value="transfer">Transferencia</option>
            <option value="otro">Otro</option>
          </select>
        </div>

        <div class="uber-box" id="uberBox">
          <label>Monto Uber</label>
          <input type="number" name="monto_uber" step="0.01" value="0">
          <small>Negativo = comisi√≥n</small>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3>Productos</h3>
        <div class="hint">Toca para agregar (+1)</div>
      </div>

      <div class="productos-grid">
        {% for p in productos %}
        <button type="button"
                class="producto-card"
                onclick='agregarProducto("{{ p.id }}", {{ p.nombre|tojson }}, {{ p.precio }}, {{ (p.categoria or "")|tojson }})'>
          <div class="producto-nombre">{{ p.nombre }}</div>
          <div class="producto-meta">
            <span class="categoria">{{ p.categoria }}</span>
            <span class="precio">{{ p.precio | money }}</span>
          </div>
        </button>
        {% endfor %}
      </div>
    </div>

  </section>

  <aside class="pos-right">

    <div class="card card-sticky">

      <div class="card-head carrito-head">
        <div>
          <h3 class="carrito-title">Carrito</h3>
          <div class="hint">+ / ‚Äì para ajustar</div>
        </div>

        <button type="button" class="btn-gray" onclick="abrirVistaCocina()">üë®‚Äçüç≥ Vista cocina</button>
      </div>

      <div class="carrito-wrap">
        <table id="carritoTable">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="total-box">
          <div>Total</div>
          <div class="total-amount" id="totalPedido">$0.00</div>
        </div>

        <div id="inputsHidden"></div>

        <button type="submit" class="btn-guardar">
          üíæ Guardar pedido
        </button>
      </div>

    </div>

  </aside>

</form>

<!-- ================== MODAL PERSONALIZACI√ìN ================== -->
<div id="customModal" class="modal">
  <div class="modal-box">

    <button class="modal-close" type="button" onclick="cerrarCustomModal()">‚úï</button>

    <h3 style="margin-top:0;">Personalizar</h3>
    <p class="hint" id="customProductoNombre" style="margin-top:-8px;"></p>

    <div class="custom-section">
      <label><strong>Prote√≠na</strong></label>
      <div id="proteinaRadios" class="custom-grid"></div>
    </div>

    <div class="custom-section">
      <label><strong>Salsa</strong></label>
      <div id="salsaRadios" class="custom-grid"></div>
      <p class="hint" style="margin:6px 0 0;">Opcional (si no aplica, d√©jalo vac√≠o).</p>
    </div>

    <div class="custom-section">
      <label><strong>Quitar</strong></label>
      <div id="sinChecks" class="custom-grid"></div>
      <p class="hint" style="margin:6px 0 0;">D√©jalo vac√≠o si va normal.</p>
    </div>

    <div class="custom-section">
      <label><strong>Notas</strong></label>
      <textarea id="notaInput" rows="3" style="width:100%;" placeholder="Ej. salsa aparte, bien dorados, etc."></textarea>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-gray" onclick="cerrarCustomModal()">Cancelar</button>
      <button type="button" class="btn-primary" onclick="confirmarCustom()">Guardar</button>
    </div>
  </div>
</div>

<!-- ================== VISTA COCINA ================== -->
<div id="cocinaModal" class="modal">
  <div class="modal-box">

    <button class="modal-close" type="button" onclick="cerrarVistaCocina()">‚úï</button>

    <h3 style="margin-top:0;">Comanda (Vista cocina)</h3>
    <p class="hint">Se imprime/visualiza con los modificadores seleccionados.</p>

    <div id="cocinaBody"></div>

    <div class="modal-actions">
      <button type="button" class="btn-gray" onclick="window.print()">Imprimir</button>
      <button type="button" class="btn-primary" onclick="cerrarVistaCocina()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ================== ESTILOS (tablet/m√≥vil + modal iPad) ================== -->
<style>
/* ====== FIXES BASE iPad/Safari (no rompe desktop) ====== */
html{
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}
*, *::before, *::after{
  box-sizing: border-box;
}

/* Ajustes layout en tablet/m√≥vil para que no se encime */
@media (max-width: 1100px){
  .pos-layout{
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .pos-left, .pos-right{
    width: 100%;
  }
  .card-sticky{
    position: static !important; /* evita overlays raros en iPad */
    top: auto !important;
  }
  #carritoTable th, #carritoTable td{
    font-size: 0.95rem;
  }
}

/* header carrito */
.carrito-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.carrito-title{ margin:0; }

/* ===== Modal robusto (desktop + iPad + m√≥vil) ===== */
.modal{
  position: fixed;
  left: 0; top: 0;
  width: 100vw;
  height: 100vh;        /* fallback */
  height: 100dvh;       /* iOS moderno */
  display: none;        /* se activa con .is-open */
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,.45);
  z-index: 2147483647;
  padding: 14px;
  box-sizing: border-box;
  -webkit-overflow-scrolling: auto;
  overscroll-behavior: contain;
}

.modal.is-open{
  display: flex;
}

/* caja del modal */
.modal-box{
  background: #fff;
  border-radius: 14px;
  padding: 16px;
  width: min(640px, 94vw);
  box-shadow: 0 10px 30px rgba(0,0,0,.25);

  max-height: calc(var(--vh, 1vh) * 88);
  overflow: auto;
  -webkit-overflow-scrolling: touch;

  transform: translateZ(0);
}

/* cerrar sticky */
.modal-close{
  position: sticky;
  top: 0;
  float: right;
  margin-left: auto;
  border: 0;
  background: rgba(255,255,255,.88);
  backdrop-filter: blur(6px);
  font-size: 18px;
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 10px;
}

/* Evita zoom iOS en inputs */
.modal-box input,
.modal-box textarea,
.modal-box select{
  font-size: 16px;
}

/* Tablet/m√≥vil: bottom-sheet */
@media (max-width: 1100px){
  .modal{
    align-items: flex-end;
    padding: 10px;
  }
  .modal-box{
    width: 100%;
    border-radius: 18px 18px 14px 14px;
    max-height: calc(var(--vh, 1vh) * 92);
  }
}

/* secciones */
.custom-section{ margin-top: 12px; }

/* grid modificadores */
.custom-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 8px;
  align-items: stretch;
}
@media (max-width: 1100px){
  .custom-grid{
    grid-template-columns: 1fr;
  }
}

/* pills touch-friendly */
.custom-pill{
  border:1px solid #ddd;
  border-radius:12px;
  padding: 12px;

  display:flex;
  gap:10px;
  align-items:center;

  width: 100%;
  min-height: 48px;
  justify-content: flex-start;
  line-height: 1.2;
  background: #fff;
  cursor: pointer;

  overflow: hidden;
}

.custom-pill input[type="radio"],
.custom-pill input[type="checkbox"]{
  margin: 0;
  flex: 0 0 20px;
  width: 20px;
  height: 20px;
  transform: translateY(0);
}

.custom-pill span{
  flex: 1;
  display: block;
  overflow-wrap: anywhere;
  word-break: break-word;
  white-space: normal;
}

.custom-pill:active{
  transform: scale(.99);
  background: #f6f6f6;
}

/* resumen modificadores dentro del carrito */
.cocina-meta{ margin-top:6px; display:flex; flex-direction:column; gap:6px; }
.tag{
  display:inline-block;
  padding:4px 8px;
  border-radius:8px;
  background:#f3f3f3;
  border:1px solid #ddd;
  font-weight:700;
  font-size:.85rem;
}
.tag-warn{
  background:#fff3cd;
  border-color:#f0c36d;
}
.nota{
  padding:6px 8px;
  border-radius:8px;
  border:1px dashed #bbb;
  background:#fff;
  font-size:.85rem;
}

/* acciones sticky dentro modal */
.modal-actions{
  position: sticky;
  bottom: 0;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(6px);
  padding-top: 10px;
  display:flex;
  gap:10px;
  justify-content:flex-end;
}

/* iOS espec√≠fico */
@supports (-webkit-touch-callout: none) {
  .modal { -webkit-transform: translateZ(0); }
}

/* ================== FIX: texto se sale a la derecha (iPad) ================== */
.pos-layout,
.card,
.carrito-wrap,
#carritoTable,
.modal-box{
  max-width: 100%;
}

body{
  overflow-x: hidden;
}

#carritoTable{
  width: 100%;
  table-layout: fixed;
}

#carritoTable th,
#carritoTable td{
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: top;
}

#carritoTable td.td-left,
#carritoTable td:first-child{
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.tag,
.nota,
.cocina-meta{
  max-width: 100%;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.qty-controls{
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: center;
}

@media (max-width: 1100px){
  #carritoTable th:nth-child(3),
  #carritoTable td:nth-child(3),
  #carritoTable th:nth-child(4),
  #carritoTable td:nth-child(4){
    font-size: 0.9rem;
  }
}
</style>

<script>
/* Fix vh real en iPad/iPhone (Safari) */
function setVH(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVH();
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', setVH);

/* ========= Datos desde BD (Jinja) ========= */
const PROTEINAS_DB = {{ proteinas|tojson }};  // [{id, nombre, ...}]
const SALSAS_DB    = {{ salsas|tojson }};     // [{id, nombre, ...}]

/* "Sin prote√≠na" como opci√≥n v√°lida (id vac√≠o) */
const PROTEINA_NONE = { id: "", nombre: "Sin prote√≠na" };

/* Opciones quitar */
const SIN_OPCIONES = ["Cebolla","Crema","Queso","Aguacate"];

/* Categor√≠as o palabras clave donde NO se deben abrir modificadores */
const NO_MOD_CATEGORIAS = ["bebidas", "extras", "extra", "complementos", "postres"];
const NO_MOD_KEYWORDS = ["coca", "refresco", "agua", "caf√©", "cafe", "chai", "capuccino", "capuchino", "jugo", "jarrito"];

let carrito = {};
let modalState = { producto_id:null, nombre:"", precio:0, uid:null };
let editandoUid = null;

function escapeHtml(str){
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function uidLinea(producto_id){
  return String(producto_id) + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
}

function normaliza(str){
  return (str || "")
    .toString()
    .trim()
    .toLowerCase();
}

function productoTieneModificadores(nombre, categoria){
  const cat = normaliza(categoria);
  const nom = normaliza(nombre);

  if (NO_MOD_CATEGORIAS.includes(cat)) return false;

  for (const kw of NO_MOD_KEYWORDS){
    if (nom.includes(kw)) return false;
  }
  return true;
}

/* helpers: lookup nombres */
function nombreProteinaPorId(id){
  if (!id) return "";
  const x = PROTEINAS_DB.find(p => String(p.id) === String(id));
  return x ? x.nombre : "";
}
function nombreSalsaPorId(id){
  if (!id) return "";
  const x = SALSAS_DB.find(s => String(s.id) === String(id));
  return x ? x.nombre : "";
}

/* Click producto */
function agregarProducto(id, nombre, precio, categoria) {
  const uid = uidLinea(id);

  carrito[uid] = {
    producto_id: id,
    nombre: nombre,
    precio: Number(precio),
    cantidad: 1,
    custom: {
      // IDs para persistencia
      proteina_id: "",
      salsa_id: "",
      // texto para cocina / UI
      proteina: "",
      salsa: "",
      sin: [],
      nota: ""
    }
  };

  renderCarrito();

  /* Solo abrir modal si aplica */
  if (productoTieneModificadores(nombre, categoria)){
    editandoUid = uid;
    modalState = { producto_id: id, nombre: nombre, precio: Number(precio), uid: uid };
    abrirCustomModal();
  }
}

/* Modal open/close (por clase) */
function abrirCustomModal(){
  document.getElementById("customProductoNombre").innerText = modalState.nombre;

  // ===== Prote√≠nas radios (desde BD + Sin prote√≠na) =====
  const radios = document.getElementById("proteinaRadios");
  radios.innerHTML = "";

  const proteinasAll = [...PROTEINAS_DB, PROTEINA_NONE];

  for (let i=0; i<proteinasAll.length; i++){
    const p = proteinasAll[i];
    const val = (p.id === "" ? "" : String(p.id));
    radios.innerHTML +=
      '<label class="custom-pill">' +
        '<input type="radio" name="proteina_radio" value="' + escapeHtml(val) + '" ' + (i===0 ? "checked" : "") + '>' +
        '<span>' + escapeHtml(p.nombre) + '</span>' +
      '</label>';
  }

  // ===== Salsas radios (desde BD) =====
  const sr = document.getElementById("salsaRadios");
  sr.innerHTML = "";

  // opci√≥n vac√≠a al inicio
  sr.innerHTML +=
    '<label class="custom-pill">' +
      '<input type="radio" name="salsa_radio" value="" checked>' +
      '<span>‚Äî (sin seleccionar)</span>' +
    '</label>';

  for (let i=0; i<SALSAS_DB.length; i++){
    const s = SALSAS_DB[i];
    sr.innerHTML +=
      '<label class="custom-pill">' +
        '<input type="radio" name="salsa_radio" value="' + escapeHtml(String(s.id)) + '">' +
        '<span>' + escapeHtml(s.nombre) + '</span>' +
      '</label>';
  }

  // ===== Quitar checks =====
  const checks = document.getElementById("sinChecks");
  checks.innerHTML = "";
  for (let i=0; i<SIN_OPCIONES.length; i++){
    const s = SIN_OPCIONES[i];
    checks.innerHTML +=
      '<label class="custom-pill">' +
        '<input type="checkbox" name="sin_check" value="' + escapeHtml(s) + '">' +
        '<span>Sin ' + escapeHtml(s) + '</span>' +
      '</label>';
  }

  document.getElementById("notaInput").value = "";

  setVH();
  document.body.style.overflow = "hidden";
  document.getElementById("customModal").classList.add("is-open");
}

function cerrarCustomModal(){
  document.getElementById("customModal").classList.remove("is-open");
  document.body.style.overflow = "";
  modalState = { producto_id:null, nombre:"", precio:0, uid:null };
  editandoUid = null;
}

function confirmarCustom(){
  const protEl = document.querySelector("input[name='proteina_radio']:checked");
  const proteina_id = protEl ? (protEl.value || "") : "";

  const salsaEl = document.querySelector("input[name='salsa_radio']:checked");
  const salsa_id = salsaEl ? (salsaEl.value || "") : "";

  const sin = [];
  document.querySelectorAll("input[name='sin_check']:checked").forEach(x => sin.push(x.value));
  const nota = document.getElementById("notaInput").value || "";

  const proteina_nombre = proteina_id ? nombreProteinaPorId(proteina_id) : "Sin prote√≠na";
  const salsa_nombre = salsa_id ? nombreSalsaPorId(salsa_id) : "";

  if (editandoUid && carrito[editandoUid]) {
    carrito[editandoUid].custom = {
      proteina_id: proteina_id,
      salsa_id: salsa_id,
      proteina: proteina_nombre || "",
      salsa: salsa_nombre || "",
      sin: sin,
      nota: nota
    };
  }

  cerrarCustomModal();
  renderCarrito();
}

/* qty */
function restarProducto(uid){
  if (!carrito[uid]) return;
  carrito[uid].cantidad -= 1;
  if (carrito[uid].cantidad <= 0) delete carrito[uid];
  renderCarrito();
}
function sumarProducto(uid){
  if (!carrito[uid]) return;
  carrito[uid].cantidad += 1;
  renderCarrito();
}
function eliminarProducto(uid){
  delete carrito[uid];
  renderCarrito();
}

/* editar */
function editarLinea(uid){
  if (!carrito[uid]) return;
  editandoUid = uid;
  const it = carrito[uid];

  modalState = { producto_id: it.producto_id, nombre: it.nombre, precio: Number(it.precio), uid: uid };
  abrirCustomModal();

  // set prote√≠na
  const targetProtId = (it.custom && it.custom.proteina_id) ? String(it.custom.proteina_id) : "";
  const protRadios = document.querySelectorAll("input[name='proteina_radio']");
  let protMatched = false;
  protRadios.forEach((r) => {
    if (String(r.value) === targetProtId){
      r.checked = true;
      protMatched = true;
    }
  });
  if (!protMatched && protRadios.length) protRadios[0].checked = true;

  // set salsa
  const targetSalsaId = (it.custom && it.custom.salsa_id) ? String(it.custom.salsa_id) : "";
  const salsaRadios = document.querySelectorAll("input[name='salsa_radio']");
  let salsaMatched = false;
  salsaRadios.forEach((r) => {
    if (String(r.value) === targetSalsaId){
      r.checked = true;
      salsaMatched = true;
    }
  });
  if (!salsaMatched && salsaRadios.length) salsaRadios[0].checked = true; // vac√≠o

  // set quitar
  const setSin = new Set((it.custom && it.custom.sin) ? it.custom.sin : []);
  document.querySelectorAll("input[name='sin_check']").forEach(c => c.checked = setSin.has(c.value));

  document.getElementById("notaInput").value = (it.custom && it.custom.nota) ? it.custom.nota : "";
}

/* render */
function renderCarrito(){
  const tbody = document.querySelector("#carritoTable tbody");
  const hidden = document.getElementById("inputsHidden");
  tbody.innerHTML = "";
  hidden.innerHTML = "";

  let total = 0;

  Object.keys(carrito).forEach(uid => {
    const item = carrito[uid];
    const subtotal = Number(item.precio) * Number(item.cantidad);
    total += subtotal;

    const protTxt = (item.custom && item.custom.proteina) ? ("PROT: " + item.custom.proteina) : "";
    const salsaTxt = (item.custom && item.custom.salsa) ? ("SALSA: " + item.custom.salsa) : "";
    const sinTxt = (item.custom && item.custom.sin && item.custom.sin.length) ? ("SIN: " + item.custom.sin.join(", ")) : "";
    const nota = (item.custom && item.custom.nota && item.custom.nota.trim()) ? item.custom.nota.trim() : "";

    let cocinaHtml = "";
    if (protTxt || salsaTxt || sinTxt || nota){
      cocinaHtml += '<div class="cocina-meta">';
      if (protTxt) cocinaHtml += '<div><span class="tag">' + escapeHtml(protTxt) + '</span></div>';
      if (salsaTxt) cocinaHtml += '<div><span class="tag">' + escapeHtml(salsaTxt) + '</span></div>';
      if (sinTxt)  cocinaHtml += '<div><span class="tag tag-warn">' + escapeHtml(sinTxt) + '</span></div>';
      if (nota) cocinaHtml += '<div class="nota"><strong>NOTA:</strong> ' + escapeHtml(nota) + '</div>';
      cocinaHtml += '</div>';
    }

    tbody.innerHTML +=
      '<tr>' +
        '<td class="td-left">' +
          escapeHtml(item.nombre) +
          cocinaHtml +
          '<div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">' +
            '<button type="button" class="btn btn-gray" onclick="editarLinea(\\'' + uid + '\\')">Editar</button>' +
          '</div>' +
        '</td>' +
        '<td>' +
          '<div class="qty-controls">' +
            '<button type="button" class="btn btn-gray" onclick="restarProducto(\\'' + uid + '\\')">‚Äì</button>' +
            '<span class="qty">' + item.cantidad + '</span>' +
            '<button type="button" class="btn btn-gray" onclick="sumarProducto(\\'' + uid + '\\')">+</button>' +
          '</div>' +
        '</td>' +
        '<td>$' + Number(item.precio).toFixed(2) + '</td>' +
        '<td><strong>$' + subtotal.toFixed(2) + '</strong></td>' +
        '<td><button type="button" class="btn btn-red" onclick="eliminarProducto(\\'' + uid + '\\')">‚úï</button></td>' +
      '</tr>';

    // ===== Hidden inputs (legacy + nuevos IDs) =====
    const proteina_id = (item.custom && item.custom.proteina_id) ? String(item.custom.proteina_id) : "";
    const salsa_id = (item.custom && item.custom.salsa_id) ? String(item.custom.salsa_id) : "";

    hidden.innerHTML +=
      '<input type="hidden" name="producto_id[]" value="' + escapeHtml(item.producto_id) + '">' +
      '<input type="hidden" name="cantidad[]" value="' + escapeHtml(item.cantidad) + '">' +

      // ‚úÖ nuevos (IDs)
      '<input type="hidden" name="proteina_id[]" value="' + escapeHtml(proteina_id) + '">' +
      '<input type="hidden" name="salsa_id[]" value="' + escapeHtml(salsa_id) + '">' +

      // legacy (texto)
      '<input type="hidden" name="proteina[]" value="' + escapeHtml(item.custom ? (item.custom.proteina || "") : "") + '">' +
      '<input type="hidden" name="sin[]" value="' + escapeHtml(item.custom && item.custom.sin ? item.custom.sin.join(",") : "") + '">' +
      '<input type="hidden" name="nota[]" value="' + escapeHtml(item.custom ? (item.custom.nota || "") : "") + '">';
  });

  document.getElementById("totalPedido").innerText = "$" + total.toFixed(2);
}

/* Uber box */
function toggleUberBox(){
  const origen = document.getElementById("origenSelect").value;
  const box = document.getElementById("uberBox");
  box.style.display = (origen === "uber") ? "block" : "none";
}

/* vista cocina */
function abrirVistaCocina(){
  const modal = document.getElementById("cocinaModal");
  const body = document.getElementById("cocinaBody");
  const uids = Object.keys(carrito);

  if (!uids.length){
    body.innerHTML = "<p>No hay productos en el carrito.</p>";
    setVH();
    document.body.style.overflow = "hidden";
    modal.classList.add("is-open");
    return;
  }

  let html = "";
  uids.forEach(uid => {
    const it = carrito[uid];

    const prot = it.custom && it.custom.proteina ? ("PROT: " + it.custom.proteina) : "PROT: ‚Äî";
    const salsa = it.custom && it.custom.salsa ? ("SALSA: " + it.custom.salsa) : "SALSA: ‚Äî";
    const sin  = it.custom && it.custom.sin && it.custom.sin.length ? ("SIN: " + it.custom.sin.join(", ")) : "SIN: ‚Äî";
    const nota = it.custom && it.custom.nota && it.custom.nota.trim() ? it.custom.nota.trim() : "";

    html +=
      '<div style="border:1px solid #ddd; border-radius:12px; padding:12px; margin-bottom:10px;">' +
        '<div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">' +
          '<div style="font-size:1.05rem; font-weight:900;">' + escapeHtml(it.nombre) + '</div>' +
          '<div style="font-size:1.05rem; font-weight:900;">x' + it.cantidad + '</div>' +
        '</div>' +
        '<div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">' +
          '<div><span class="tag">' + escapeHtml(prot) + '</span></div>' +
          '<div><span class="tag">' + escapeHtml(salsa) + '</span></div>' +
          '<div><span class="tag tag-warn">' + escapeHtml(sin) + '</span></div>' +
          (nota ? '<div class="nota"><strong>NOTA:</strong> ' + escapeHtml(nota) + '</div>' : "") +
        '</div>' +
      '</div>';
  });

  body.innerHTML = html;
  setVH();
  document.body.style.overflow = "hidden";
  modal.classList.add("is-open");
}

function cerrarVistaCocina(){
  document.getElementById("cocinaModal").classList.remove("is-open");
  document.body.style.overflow = "";
}

/* init + cerrar modales al click fuera */
document.addEventListener("DOMContentLoaded", () => {
  toggleUberBox();
  document.getElementById("origenSelect").addEventListener("change", toggleUberBox);

  document.addEventListener("click", (e) => {
    const cm = document.getElementById("customModal");
    if (cm && cm.classList.contains("is-open") && e.target === cm) cerrarCustomModal();

    const km = document.getElementById("cocinaModal");
    if (km && km.classList.contains("is-open") && e.target === km) cerrarVistaCocina();
  });
});
</script>

{% endblock %}
