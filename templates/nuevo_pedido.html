{% extends "base.html" %}
{% block content %}

<h2 class="pos-title">ðŸ§¾ Nuevo pedido</h2>

<form method="post" id="pedidoForm" class="pos-layout">

    <!-- ================== PANEL IZQUIERDO ================== -->
    <section class="pos-left">

        <!-- ================== DATOS GENERALES ================== -->
        <div class="card">
            <div class="card-head">
                <h3>Datos del pedido</h3>
            </div>

            <div class="form-grid">

                <div>
                    <label>Fecha</label>
                    <input type="datetime-local" name="fecha">
                    <small>VacÃ­o = ahora</small>
                </div>

                <div>
                    <label>Origen</label>
                    <select name="origen" id="origenSelect">
                        <option value="mostrador">Mostrador</option>
                        <option value="uber">Uber</option>
                        <option value="didi">Didi</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <div>
                    <label>Mesero</label>
                    <input type="text" name="mesero" placeholder="Nombre">
                </div>

                <div>
                    <label>MÃ©todo de pago</label>
                    <select name="metodo_pago">
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                        <option value="transfer">Transferencia</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <div class="uber-box" id="uberBox">
                    <label>Monto Uber</label>
                    <input type="number" name="monto_uber" step="0.01" value="0">
                    <small>Negativo = comisiÃ³n</small>
                </div>

            </div>
        </div>

        <!-- ================== PRODUCTOS ================== -->
        <div class="card">
            <div class="card-head">
                <h3>Productos</h3>
                <div class="hint">Toca para agregar (+1)</div>
            </div>

            <div class="productos-grid">
                {% for p in productos %}
                <button type="button"
                        class="producto-card"
                        onclick="agregarProducto('{{ p.id }}', '{{ p.nombre }}', {{ p.precio }})">
                    <div class="producto-nombre">{{ p.nombre }}</div>
                    <div class="producto-meta">
                        <span class="categoria">{{ p.categoria }}</span>
                        <span class="precio">{{ p.precio | money }}</span>
                    </div>
                </button>
                {% endfor %}
            </div>
        </div>

    </section>

    <!-- ================== PANEL DERECHO (CARRITO) ================== -->
    <aside class="pos-right">

        <div class="card card-sticky">

            <div class="card-head">
                <h3>Carrito</h3>
                <div class="hint">+ / â€“ para ajustar</div>
            </div>

            <div class="carrito-wrap">
                <table id="carritoTable">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div class="total-box">
                    <div>Total</div>
                    <div class="total-amount" id="totalPedido">$0.00</div>
                </div>

                <!-- Inputs ocultos -->
                <div id="inputsHidden"></div>

                <button type="submit" class="btn-guardar">
                    ðŸ’¾ Guardar pedido
                </button>
            </div>

        </div>

    </aside>

</form>

<!-- ================== SCRIPT ================== -->
<script>
let carrito = {};

// âž• Agregar producto (+1)
function agregarProducto(id, nombre, precio) {
    if (!carrito[id]) {
        carrito[id] = { nombre, precio, cantidad: 1 };
    } else {
        carrito[id].cantidad += 1;
    }
    renderCarrito();
}

// âž– Restar producto
function restarProducto(id) {
    if (!carrito[id]) return;
    carrito[id].cantidad -= 1;
    if (carrito[id].cantidad <= 0) delete carrito[id];
    renderCarrito();
}

// âŒ Eliminar producto
function eliminarProducto(id) {
    delete carrito[id];
    renderCarrito();
}

// ðŸ§  Render carrito + inputs hidden + total
function renderCarrito() {
    const tbody = document.querySelector("#carritoTable tbody");
    const hidden = document.getElementById("inputsHidden");
    tbody.innerHTML = "";
    hidden.innerHTML = "";

    let total = 0;

    for (const id in carrito) {
        const item = carrito[id];
        const subtotal = item.precio * item.cantidad;
        total += subtotal;

        tbody.innerHTML += `
            <tr>
                <td class="td-left">${item.nombre}</td>
                <td>
                    <div class="qty-controls">
                        <button type="button" class="btn btn-gray" onclick="restarProducto('${id}')">â€“</button>
                        <span class="qty">${item.cantidad}</span>
                        <button type="button" class="btn btn-gray"
                            onclick="agregarProducto('${id}','${item.nombre}',${item.precio})">+</button>
                    </div>
                </td>
                <td>$${item.precio.toFixed(2)}</td>
                <td><strong>$${subtotal.toFixed(2)}</strong></td>
                <td>
                    <button type="button" class="btn btn-red" onclick="eliminarProducto('${id}')">âœ•</button>
                </td>
            </tr>
        `;

        hidden.innerHTML += `
            <input type="hidden" name="producto_id[]" value="${id}">
            <input type="hidden" name="cantidad[]" value="${item.cantidad}">
        `;
    }

    document.getElementById("totalPedido").innerText = `$${total.toFixed(2)}`;
}

// UX: mostrar/ocultar "Monto Uber" segÃºn origen
function toggleUberBox() {
    const origen = document.getElementById("origenSelect").value;
    const box = document.getElementById("uberBox");
    box.style.display = (origen === "uber") ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", () => {
    toggleUberBox();
    document.getElementById("origenSelect").addEventListener("change", toggleUberBox);
});
</script>

{% endblock %}
