{% extends "base.html" %}
{% block content %}

<h2>ðŸ§¾ Nuevo pedido</h2>

<form method="post" id="pedidoForm">

<!-- ================== DATOS GENERALES ================== -->
<div class="card">

    <h3>Datos del pedido</h3>

    <div class="form-grid">

        <div>
            <label>Fecha</label>
            <input type="datetime-local" name="fecha">
            <small>VacÃ­o = ahora</small>
        </div>

        <div>
            <label>Origen</label>
            <select name="origen">
                <option value="mostrador">Mostrador</option>
                <option value="uber">Uber</option>
                <option value="didi">Didi</option>
                <option value="otro">Otro</option>
            </select>
        </div>

        <div>
            <label>Mesero</label>
            <input type="text" name="mesero" placeholder="Nombre">
        </div>

        <div>
            <label>MÃ©todo de pago</label>
            <select name="metodo_pago">
                <option value="efectivo">Efectivo</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="transfer">Transferencia</option>
                <option value="otro">Otro</option>
            </select>
        </div>

        <div>
            <label>Monto Uber</label>
            <input type="number" name="monto_uber" step="0.01" value="0">
            <small>Negativo = comisiÃ³n</small>
        </div>

    </div>
</div>

<!-- ================== PRODUCTOS ================== -->
<div class="card">

    <h3>Productos</h3>

    <div class="productos-grid">
        {% for p in productos %}
        <div class="producto-card"
             onclick="agregarProducto('{{ p.id }}', '{{ p.nombre }}', {{ p.precio }})">
            <strong>{{ p.nombre }}</strong>
            <span class="categoria">{{ p.categoria }}</span>
            <span class="precio">${{ p.precio }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ================== CARRITO ================== -->
<div class="card">

    <h3>Carrito</h3>

    <table id="carritoTable">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cant.</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="total-box">
        Total: <span id="totalPedido">$0.00</span>
    </div>

    <div id="inputsHidden"></div>

    <button type="submit" class="btn-guardar">
        ðŸ’¾ Guardar pedido
    </button>

</div>

</form>



<!-- ================== SCRIPT ================== -->
<script>
let carrito = {};

function agregarProducto(id, nombre, precio) {
    if (!carrito[id]) {
        carrito[id] = { nombre, precio, cantidad: 1 };
    } else {
        carrito[id].cantidad += 1;
    }
    renderCarrito();
}

function restarProducto(id) {
    carrito[id].cantidad--;
    if (carrito[id].cantidad <= 0) delete carrito[id];
    renderCarrito();
}

function eliminarProducto(id) {
    delete carrito[id];
    renderCarrito();
}

function renderCarrito() {
    const tbody = document.querySelector("#carritoTable tbody");
    const hidden = document.getElementById("inputsHidden");

    tbody.innerHTML = "";
    hidden.innerHTML = "";

    let total = 0;

    for (const id in carrito) {
        const item = carrito[id];
        const subtotal = item.precio * item.cantidad;
        total += subtotal;

        tbody.innerHTML += `
            <tr>
                <td>${item.nombre}</td>
                <td>
                    <button type="button" class="btn btn-gray" onclick="restarProducto('${id}')">â€“</button>
                    ${item.cantidad}
                    <button type="button" class="btn btn-gray"
                        onclick="agregarProducto('${id}','${item.nombre}',${item.precio})">+</button>
                </td>
                <td>$${item.precio.toFixed(2)}</td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-red"
                        onclick="eliminarProducto('${id}')">X</button>
                </td>
            </tr>
        `;

        hidden.innerHTML += `
            <input type="hidden" name="producto_id[]" value="${id}">
            <input type="hidden" name="cantidad[]" value="${item.cantidad}">
        `;
    }

    document.getElementById("totalPedido").innerText = `$${total.toFixed(2)}`;
}
</script>

{% endblock %}
