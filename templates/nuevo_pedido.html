{% extends "base.html" %}
{% block content %}

<div class="pos-layout">

    <!-- ================== PRODUCTOS ================== -->
    <section class="productos-panel">
        <h2>Productos</h2>

        <div class="productos-grid">
            {% for p in productos %}
            <button class="producto-card"
                    type="button"
                    onclick="agregarProducto('{{ p.id }}','{{ p.nombre }}',{{ p.precio }})">
                <div class="producto-nombre">{{ p.nombre }}</div>
                <div class="producto-precio">{{ p.precio | money }}</div>
            </button>
            {% endfor %}
        </div>
    </section>

    <!-- ================== CARRITO ================== -->
    <section class="carrito-panel">

        <h2>Pedido</h2>

        <div class="carrito-items" id="carritoItems"></div>

        <div class="total-box">
            TOTAL
            <div id="totalPedido">$0.00</div>
        </div>

        <form method="post" id="pedidoForm">
            <input type="hidden" name="origen" value="mostrador">
            <input type="hidden" name="metodo_pago" value="pendiente">

            <div id="inputsHidden"></div>

            <button type="submit" class="btn-guardar">
                GUARDAR PEDIDO
            </button>
        </form>

    </section>

</div>

<script>
let carrito = {};

function agregarProducto(id, nombre, precio) {
    if (!carrito[id]) {
        carrito[id] = { nombre, precio, cantidad: 1 };
    } else {
        carrito[id].cantidad++;
    }
    renderCarrito();
}

function restarProducto(id) {
    carrito[id].cantidad--;
    if (carrito[id].cantidad <= 0) delete carrito[id];
    renderCarrito();
}

function eliminarProducto(id) {
    delete carrito[id];
    renderCarrito();
}

function renderCarrito() {
    const cont = document.getElementById("carritoItems");
    const hidden = document.getElementById("inputsHidden");

    cont.innerHTML = "";
    hidden.innerHTML = "";

    let total = 0;

    for (const id in carrito) {
        const it = carrito[id];
        const subtotal = it.precio * it.cantidad;
        total += subtotal;

        cont.innerHTML += `
            <div class="carrito-row">
                <div class="carrito-info">
                    <strong>${it.nombre}</strong>
                    <span>$${subtotal.toFixed(2)}</span>
                </div>

                <div class="carrito-controls">
                    <button type="button" onclick="restarProducto('${id}')">–</button>
                    <span>${it.cantidad}</span>
                    <button type="button" onclick="agregarProducto('${id}','${it.nombre}',${it.precio})">+</button>
                    <button type="button" class="btn-delete" onclick="eliminarProducto('${id}')">✕</button>
                </div>
            </div>
        `;

        hidden.innerHTML += `
            <input type="hidden" name="producto_id[]" value="${id}">
            <input type="hidden" name="cantidad[]" value="${it.cantidad}">
        `;
    }

    document.getElementById("totalPedido").innerText = `$${total.toFixed(2)}`;
}
</script>

{% endblock %}
