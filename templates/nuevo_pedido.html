{% extends "base.html" %}
{% block content %}
<h2>Nuevo pedido</h2>

<form method="post">
    <label>Origen:</label>
    <select name="origen">
        <option value="mostrador">Mostrador</option>
        <option value="uber">Uber</option>
        <option value="didi">Didi</option>
        <option value="otro">Otro</option>
    </select>

    <label>Mesero:</label>
    <input type="text" name="mesero">

    <label>Método de pago:</label>
    <select name="metodo_pago">
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
        <option value="transfer">Transfer</option>
        <option value="otro">Otro</option>
    </select>

    <label>Monto Uber (usa negativo para comisión, ej. -30):</label>
    <input type="number" name="monto_uber" step="0.01" value="0">

    <hr>
    <h3>Productos</h3>
    <p>Puedes capturar varias líneas de producto en un solo pedido.</p>

    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Salsa</th>
                <th>Proteína</th>
            </tr>
        </thead>
        <tbody>
            {% for i in range(8) %}
            <tr>
                <td>
                    <select name="producto_id">
                        <option value="">--</option>
                        {% for p in productos %}
                        <option value="{{ p.id }}">{{ p.categoria }} - {{ p.nombre }} (${{ p.precio }})</option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="number" name="cantidad" min="0" value="0"></td>
                <td>
                    <select name="salsa_id">
                        <option value="">--</option>
                        {% for s in salsas %}
                        <option value="{{ s.id }}">{{ s.nombre }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select name="proteina_id">
                        <option value="">--</option>
                        {% for pr in proteinas %}
                        <option value="{{ pr.id }}">{{ pr.nombre }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <br>
    <h3>Total del Pedido: <span id="totalPedido">$0.00</span></h3>

    <button type="submit">Guardar pedido</button>
</form>

<!-- ===========================
     SCRIPT PARA CALCULAR TOTAL
=========================== -->
<script>
    // Precios enviados desde Flask
    const precios = {
        {% for p in productos %}
        "{{ p.id }}": {{ p.precio }},
        {% endfor %}
    };

    function calcularTotal() {
        let total = 0;

        const filas = document.querySelectorAll("tbody tr");

        filas.forEach((fila) => {
            const selectProducto = fila.querySelector("select[name='producto_id']");
            const inputCantidad = fila.querySelector("input[name='cantidad']");

            if (!selectProducto || !inputCantidad) return;

            const prodId = selectProducto.value;
            const cantidad = parseInt(inputCantidad.value) || 0;

            if (prodId && cantidad > 0) {
                const precio = precios[prodId] || 0;
                total += precio * cantidad;
            }
        });

        document.getElementById("totalPedido").innerText = `$${total.toFixed(2)}`;
    }

    // Ejecutar cálculo cada vez que cambian producto o cantidad
    document.addEventListener("change", function(e) {
        if (e.target.name === "producto_id" || e.target.name === "cantidad") {
            calcularTotal();
        }
    });
</script>

{% endblock %}
