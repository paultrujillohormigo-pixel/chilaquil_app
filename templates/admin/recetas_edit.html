{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <div>
    <h2 style="margin:0;">üßæ Receta: {{ platillo.nombre }}</h2>
    <p class="muted" style="margin:6px 0 0;">
      Izquierda: costeo usando <b>Manual</b> (si est√° activo). Derecha: referencia de <b>Compras</b>.
    </p>
  </div>
  <div class="page-actions">
    <a class="btn btn-secondary" href="{{ url_for('costeo.recetas_index') }}">‚Üê Volver</a>
  </div>
</div>

{% set costo_total = (costeo.costo_total if costeo and costeo.costo_total is not none else none) %}
{% set precio_actual = (costeo.precio_actual if costeo and costeo.precio_actual is not none else none) %}
{% set ganancia_sugerida = (costeo.ganancia_sugerida if costeo and costeo.ganancia_sugerida is not none else none) %}
{% set precio_sugerido = (costeo.precio_sugerido if costeo and costeo.precio_sugerido is not none else none) %}

{% set ganancia_actual = none %}
{% set margen_actual = none %}
{% if precio_actual and precio_actual > 0 and costo_total is not none %}
  {% set ganancia_actual = (precio_actual - costo_total) %}
  {% set margen_actual = ((ganancia_actual / precio_actual) * 100) %}
{% endif %}

{% if costeo %}
  <div class="card" style="margin:12px 0;">
    <div class="card-head">
      <h3 style="margin:0;">Resumen</h3>
      <p class="muted" style="margin:6px 0 0;">
        Si un ingrediente no tiene precio manual ni compras, el platillo queda incompleto.
      </p>
    </div>

    <div class="summary-grid">
      <div class="summary-item">
        <div class="k">Costo insumos</div>
        <div class="v">${{ "%.2f"|format(costeo.costo_insumos or 0) }}</div>
      </div>
      <div class="summary-item">
        <div class="k">Operativos (75%)</div>
        <div class="v">${{ "%.2f"|format(costeo.costo_operativo or 0) }}</div>
      </div>
      <div class="summary-item">
        <div class="k">Costo total</div>
        <div class="v">${{ "%.2f"|format(costeo.costo_total or 0) }}</div>
      </div>
      <div class="summary-item">
        <div class="k">Precio sugerido</div>
        <div class="v"><b>${{ "%.2f"|format(costeo.precio_sugerido or 0) }}</b></div>
      </div>

      <div class="summary-item">
        <div class="k">Ganancia sugerida</div>
        <div class="v">${{ "%.2f"|format(costeo.ganancia_sugerida or 0) }}</div>

        <div class="sub">
          <div class="k2">Ganancia con precio actual</div>
          {% if ganancia_actual is not none %}
            <div class="v2">
              <b>${{ "%.2f"|format(ganancia_actual) }}</b>
              <span class="muted">({{ "%.2f"|format(margen_actual) }}% margen)</span>
            </div>
          {% else %}
            <div class="v2 muted">‚Äî</div>
          {% endif %}
        </div>
      </div>

      <div class="summary-item">
        <div class="k">Precio actual</div>
        <div class="v">
          {% if precio_actual %}
            ${{ "%.2f"|format(precio_actual) }}
          {% else %}
            <span class="muted">‚Äî</span>
          {% endif %}
        </div>

        {% if costeo.insumos_sin_precio is defined and costeo.insumos_sin_precio and costeo.insumos_sin_precio > 0 %}
          <div class="pill pill-warn" style="margin-top:8px;">
            ‚ö†Ô∏è Incompleto ({{ costeo.insumos_sin_precio }})
          </div>
        {% else %}
          <div class="pill pill-ok" style="margin-top:8px;">
            ‚úÖ OK
          </div>
        {% endif %}
      </div>
    </div>

    <small class="muted" style="display:block; margin-top:10px;">
      Este resumen viene de <code>v_costeo_platillos</code>.
    </small>
  </div>
{% endif %}

<form method="post" id="recetaForm">

  <!-- ========= AGREGAR INSUMOS ========= -->
  <div class="card" style="padding:12px; margin:12px 0;">
    <h3 style="margin:0 0 10px;">Agregar ingrediente</h3>

    <div class="add-row">
      <div>
        <label class="lbl">Insumo</label>
        <select id="addInsumo" class="inp">
          <option value="">‚Äî Selecciona ‚Äî</option>
          {% for i in insumos %}
            <option
              value="{{ i.id }}"
              data-nombre="{{ i.nombre }}"
              data-unidad="{{ i.unidad_base }}"
              data-merma="{{ i.merma_pct }}"
              data-compra="{{ i.costo_unitario if i.costo_unitario is not none else '' }}"
            >
              {{ i.nombre }} ({{ i.unidad_base }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="lbl">Cantidad</label>
        <input id="addCantidad" type="number" step="0.01" class="inp" placeholder="Ej. 100">
      </div>

      <div>
        <label class="lbl">$ Manual (opcional)</label>
        <input id="addPrecioManual" type="number" step="0.0001" class="inp" placeholder="$/unidad base">
      </div>

      <div class="add-actions">
        <label class="chk">
          <input id="addUsarManual" type="checkbox">
          <span>Usar manual</span>
        </label>

        <button type="button" class="btn btn-primary" onclick="agregarInsumo()">
          ‚ûï Agregar
        </button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px; font-size:13px;">
      Tip: si marcas ‚ÄúUsar manual‚Äù pero dejas vac√≠o el precio, se guardar√° usando compras.
    </div>
  </div>

  <!-- ========= DOS TABLAS: MANUAL vs COMPRAS ========= -->
  <div class="split">
    <!-- IZQUIERDA: USADO -->
    <div class="card">
      <div class="card-head">
        <h3 style="margin:0;">üìå Precio usado (Manual manda)</h3>
        <p class="muted" style="margin:6px 0 0;">Esto es lo que se usa para costear el platillo.</p>
      </div>

      <div class="table-wrap">
        <table class="table" id="tblUsado">
          <thead>
            <tr>
              <th>Insumo</th>
              <th style="width:110px;">Cant.</th>
              <th style="width:70px;">Und</th>
              <th style="width:140px;">$ Manual</th>
              <th style="width:70px;">Usar</th>
              <th style="width:140px;">$ Usado</th>
              <th style="width:140px;">Subtotal</th>
              <th style="width:90px;">Quitar</th>
            </tr>
          </thead>
          <tbody id="recetaBody">
            {% for r in receta %}
            <tr class="{% if r.costo_unitario_usado is none %}row-warn{% endif %}">
              <td>
                <b>{{ r.insumo_nombre }}</b>
                {% if r.merma_pct and r.merma_pct != 0 %}
                  <div class="muted" style="font-size:12px;">Merma: {{ r.merma_pct }}%</div>
                {% endif %}
                {% if r.costo_unitario_usado is none %}
                  <div class="warn-text"><b>SIN PRECIO</b></div>
                {% endif %}
              </td>

              <!-- arrays alineados -->
              <td style="display:none;">
                <input type="hidden" name="insumo_id[]" value="{{ r.insumo_id }}">
              </td>

              <td>
                <input type="number" step="0.01" name="cantidad_base[]" value="{{ r.cantidad_base }}" class="inp-sm">
              </td>

              <td>{{ r.unidad_base }}</td>

              <td>
                <input type="number" step="0.0001" name="precio_manual[]"
                       value="{{ r.precio_manual if r.precio_manual is not none else '' }}"
                       placeholder="$/{{ r.unidad_base }}"
                       class="inp-sm">
              </td>

              <td style="text-align:center;">
                <input type="hidden" name="usa_precio_manual[]" value="{{ '1' if r.usa_precio_manual else '0' }}">
                <input type="checkbox"
                       {% if r.usa_precio_manual %}checked{% endif %}
                       onchange="this.previousElementSibling.value = this.checked ? '1' : '0'; syncRowToCompras(this);">
              </td>

              <td class="usado">
                {{ r.costo_unitario_usado if r.costo_unitario_usado is not none else '‚Äî' }}
              </td>

              <td class="subt">
                {{ r.subtotal if r.subtotal is not none else '‚Äî' }}
              </td>

              <td>
                <button type="button" class="btn btn-danger" onclick="quitarFila(this)">üóë</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px; font-size:13px;">
        Nota: los subtotales se recalculan completamente al guardar (SQL). Aqu√≠ se muestran los valores actuales.
      </div>
    </div>

    <!-- DERECHA: COMPRAS -->
    <div class="card">
      <div class="card-head">
        <h3 style="margin:0;">üßæ Precio de compras (referencia)</h3>
        <p class="muted" style="margin:6px 0 0;">Esto es lo √∫ltimo registrado en compras (no se edita aqu√≠).</p>
      </div>

      <div class="table-wrap">
        <table class="table" id="tblCompras">
          <thead>
            <tr>
              <th>Insumo</th>
              <th style="width:110px;">Cant.</th>
              <th style="width:70px;">Und</th>
              <th style="width:140px;">$ Compras</th>
              <th style="width:140px;">Subtotal</th>
            </tr>
          </thead>
          <tbody id="comprasBody">
            {% for r in receta %}
            <tr data-insumo="{{ r.insumo_id }}">
              <td>
                <b>{{ r.insumo_nombre }}</b>
                {% if r.merma_pct and r.merma_pct != 0 %}
                  <div class="muted" style="font-size:12px;">Merma: {{ r.merma_pct }}%</div>
                {% endif %}
              </td>
              <td class="cant">{{ r.cantidad_base }}</td>
              <td>{{ r.unidad_base }}</td>
              <td class="compra">
                {{ r.costo_unitario_compra if r.costo_unitario_compra is not none else '‚Äî' }}
              </td>
              <td class="subcompra">
                {# subtotal compras (solo referencia) #}
                {% if r.costo_unitario_compra is not none %}
                  {{ "%.2f"|format((r.cantidad_base * r.costo_unitario_compra * (1 + (r.merma_pct/100))) ) }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px; font-size:13px;">
        Tip: √∫salo para comparar si tu manual se est√° yendo arriba/abajo de lo que realmente compras.
      </div>
    </div>
  </div>

  <div class="footer-actions">
    <button type="submit" class="btn btn-primary">Guardar receta</button>
    <a href="{{ url_for('costeo.recetas_index') }}" class="btn btn-secondary">Cancelar</a>
  </div>

</form>

<style>
  .page-head{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:16px}
  .page-actions{display:flex;gap:10px;flex-wrap:wrap}

  .card{background:#fff;border:1px solid #e7e7e7;border-radius:14px;padding:16px}
  .card-head h3{margin:0}
  .muted{opacity:.7}
  .warn-text{font-size:12px;color:#b00020;margin-top:4px}

  .summary-grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:12px;margin-top:12px}
  .summary-item{border:1px solid #eee;border-radius:12px;padding:12px}
  .summary-item .k{font-size:12px;opacity:.75}
  .summary-item .v{font-size:18px;margin-top:6px}
  .summary-item .sub{margin-top:10px;padding-top:10px;border-top:1px dashed #eee}
  .summary-item .k2{font-size:12px;opacity:.75}
  .summary-item .v2{margin-top:6px}

  .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #ddd;width:max-content}
  .pill-ok{background:#f3fff3;border-color:#bfe8bf}
  .pill-warn{background:#fff4f4;border-color:#f0b4b4}

  .table-wrap{overflow:auto;margin-top:10px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:12px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle;white-space:nowrap}
  .row-warn td{background:#fff8f8}

  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;text-decoration:none;border:1px solid #ddd;background:#fff;cursor:pointer}
  .btn-primary{background:#111;color:#fff;border-color:#111}
  .btn-secondary{background:#f6f6f6;color:#111}
  .btn-danger{background:#fff3f3;color:#b00020;border-color:#f0b4b4;padding:8px 10px}

  .lbl{display:block;font-size:12px;opacity:.75;margin-bottom:6px}
  .inp{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px}
  .inp-sm{width:110px;padding:8px 10px;border:1px solid #ddd;border-radius:10px}

  .add-row{display:grid;grid-template-columns: 1.6fr 0.6fr 0.8fr 0.8fr; gap:12px; align-items:end}
  .add-actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}

  .split{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
  @media (max-width: 1100px){
    .split{grid-template-columns:1fr}
    .summary-grid{grid-template-columns:1fr}
  }

  .footer-actions{display:flex;gap:10px;align-items:center;margin-top:14px}
</style>

<script>
  function quitarFila(btn) {
    const tr = btn.closest('tr');
    if (!tr) return;

    // tambi√©n elimina su espejo en compras
    const insumoId = tr.querySelector('input[name="insumo_id[]"]')?.value;
    if (insumoId) {
      const mirror = document.querySelector('#comprasBody tr[data-insumo="'+insumoId+'"]');
      if (mirror) mirror.remove();
    }

    tr.remove();
  }

  function agregarInsumo() {
    const sel = document.getElementById('addInsumo');
    const cant = document.getElementById('addCantidad');
    const pm = document.getElementById('addPrecioManual');
    const um = document.getElementById('addUsarManual');

    const insumoId = sel.value;
    const opt = sel.options[sel.selectedIndex];

    if (!insumoId) { alert('Selecciona un insumo.'); return; }

    const cantidad = (cant.value || '').trim();
    if (!cantidad || Number(cantidad) <= 0) { alert('Cantidad inv√°lida.'); return; }

    // evita duplicados
    const exists = Array.from(document.querySelectorAll('input[name="insumo_id[]"]'))
      .some(i => i.value === insumoId);
    if (exists) { alert('Ese insumo ya est√° en la receta.'); return; }

    const nombre = opt.getAttribute('data-nombre') || 'Insumo';
    const unidad = opt.getAttribute('data-unidad') || '';
    const merma = opt.getAttribute('data-merma') || '';
    const compra = opt.getAttribute('data-compra') || '';

    const precioManual = (pm.value || '').trim();
    const usarManual = (um.checked && precioManual !== '') ? '1' : '0';

    // agrega a tabla "usado"
    const body = document.getElementById('recetaBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <b>${escapeHtml(nombre)}</b>
        ${merma && merma !== '0.00' ? `<div class="muted" style="font-size:12px;">Merma: ${escapeHtml(merma)}%</div>` : ``}
      </td>

      <td style="display:none;">
        <input type="hidden" name="insumo_id[]" value="${escapeAttr(insumoId)}">
      </td>

      <td>
        <input type="number" step="0.01" name="cantidad_base[]" value="${escapeAttr(cantidad)}" class="inp-sm"
               oninput="syncCantidadToCompras(this)">
      </td>

      <td>${escapeHtml(unidad)}</td>

      <td>
        <input type="number" step="0.0001" name="precio_manual[]" value="${escapeAttr(precioManual)}"
               placeholder="$/${escapeHtml(unidad)}" class="inp-sm"
               oninput="syncRowToCompras(this)">
      </td>

      <td style="text-align:center;">
        <input type="hidden" name="usa_precio_manual[]" value="${usarManual}">
        <input type="checkbox" ${usarManual === '1' ? 'checked' : ''} onchange="this.previousElementSibling.value = this.checked ? '1' : '0';">
      </td>

      <td class="usado">‚Äî</td>
      <td class="subt">‚Äî</td>

      <td>
        <button type="button" class="btn btn-danger" onclick="quitarFila(this)">üóë</button>
      </td>
    `;
    body.appendChild(tr);

    // agrega espejo en tabla compras
    const cb = document.getElementById('comprasBody');
    const tr2 = document.createElement('tr');
    tr2.setAttribute('data-insumo', insumoId);
    tr2.innerHTML = `
      <td>
        <b>${escapeHtml(nombre)}</b>
        ${merma && merma !== '0.00' ? `<div class="muted" style="font-size:12px;">Merma: ${escapeHtml(merma)}%</div>` : ``}
      </td>
      <td class="cant">${escapeHtml(cantidad)}</td>
      <td>${escapeHtml(unidad)}</td>
      <td class="compra">${compra ? escapeHtml(compra) : '‚Äî'}</td>
      <td class="subcompra">‚Äî</td>
    `;
    cb.appendChild(tr2);

    // limpia inputs
    cant.value = '';
    pm.value = '';
    um.checked = false;
    sel.value = '';
  }

  function syncCantidadToCompras(input) {
    const tr = input.closest('tr');
    const insumoId = tr.querySelector('input[name="insumo_id[]"]')?.value;
    const mirror = document.querySelector('#comprasBody tr[data-insumo="'+insumoId+'"]');
    if (!mirror) return;

    const val = input.value;
    mirror.querySelector('.cant').textContent = val;
  }

  // (no calculamos subtotales en vivo; se recalcula al guardar)
  function syncRowToCompras(_) { /* placeholder */ }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, function(m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }
  function escapeAttr(s) { return escapeHtml(s); }
</script>

{% endblock %}
