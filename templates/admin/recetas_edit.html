{% extends "base.html" %}
{% block content %}

<h2>Receta: {{ platillo.nombre }}</h2>

{% if costeo %}
  <div class="card" style="margin:12px 0; padding:12px;">
    <strong>Resumen costeo (vista):</strong>
    <div style="margin-top:6px; font-size:14px;">
      {% for k, v in costeo.items() %}
        <div><b>{{ k }}</b>: {{ v }}</div>
      {% endfor %}
    </div>
    <small style="display:block; margin-top:8px;">
      Nota: este resumen depende de <code>v_costeo_platillos</code>. Si aún no actualizamos la vista,
      puede que no refleje precio manual.
    </small>
  </div>
{% endif %}

<form method="post">

  <div class="card" style="padding:12px; margin:12px 0;">
    <h3 style="margin:0 0 10px;">Ingredientes actuales</h3>

    {% if receta and receta|length > 0 %}
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #ddd;">
            <th>Insumo</th>
            <th style="width:120px;">Cantidad</th>
            <th style="width:70px;">Unidad</th>
            <th style="width:150px;">$ Manual</th>
            <th style="width:90px;">Usar</th>
            <th style="width:140px;">$ Compras</th>
            <th style="width:140px;">$ Usado</th>
            <th style="width:140px;">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for r in receta %}
          <tr style="border-bottom:1px solid #eee;">
            <td>
              <b>{{ r.insumo_nombre }}</b>
              {% if r.merma_pct and r.merma_pct != 0 %}
                <div style="font-size:12px; opacity:.8;">Merma: {{ r.merma_pct }}%</div>
              {% endif %}
              {% if r.costo_unitario_usado is none %}
                <div style="font-size:12px; color:#b00020;"><b>SIN PRECIO</b> (pon manual o registra compra)</div>
              {% endif %}
            </td>

            <!-- Insumo id -->
            <td style="display:none;">
              <input type="hidden" name="insumo_id[]" value="{{ r.insumo_id }}">
            </td>

            <td>
              <input type="number" step="0.01" name="cantidad_base[]" value="{{ r.cantidad_base }}"
                     style="width:110px;">
            </td>

            <td>{{ r.unidad_base }}</td>

            <td>
              <input type="number" step="0.0001" name="precio_manual[]"
                     value="{{ r.precio_manual if r.precio_manual is not none else '' }}"
                     placeholder="$/{{ r.unidad_base }}"
                     style="width:140px;">
            </td>

            <td style="text-align:center;">
              <!-- Truco robusto: manda 0 siempre y 1 si checked -->
              <input type="hidden" name="usa_precio_manual[]" value="0">
              <input type="checkbox" value="1"
                     {% if r.usa_precio_manual %}checked{% endif %}
                     onchange="this.previousElementSibling.value = this.checked ? '1' : '0';">
            </td>

            <td>
              {{ r.costo_unitario_compra if r.costo_unitario_compra is not none else '—' }}
            </td>

            <td>
              {{ r.costo_unitario_usado if r.costo_unitario_usado is not none else '—' }}
            </td>

            <td>
              {{ r.subtotal if r.subtotal is not none else '—' }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No hay ingredientes todavía.</p>
    {% endif %}
  </div>

  <div style="display:flex; gap:10px; align-items:center;">
    <button type="submit" class="btn-primary">Guardar receta</button>
    <a href="{{ url_for('costeo.recetas_index') }}" class="btn-gray">Volver</a>
  </div>

</form>

<hr style="margin:18px 0;">

<div class="card" style="padding:12px;">
  <h3 style="margin:0 0 10px;">Agregar ingredientes (rápido)</h3>
  <p style="margin:0 0 10px; opacity:.85;">
    Esto es opcional. Si tú ya tienes otro UI para agregar insumos, ignora esta sección.
  </p>

  <!-- Si quieres usar el catálogo para agregar nuevos insumos aquí mismo, lo armamos después -->
  <div style="font-size:13px; opacity:.85;">
    Catálogo disponible: {{ insumos|length }} insumos activos.
  </div>
</div>

{% endblock %}
