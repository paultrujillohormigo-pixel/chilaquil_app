{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <div>
    <h2 style="margin:0;">üßæ Receta: {{ platillo.nombre }}</h2>
    <p class="muted" style="margin:6px 0 0;">
      Comparativa arriba: <b>Usado (manual manda)</b> vs <b>Solo compras</b>.
    </p>
  </div>
  <div class="page-actions">
    <a class="btn btn-secondary" href="{{ url_for('costeo.recetas_index') }}">‚Üê Volver</a>
  </div>
</div>

{# =======================
   RESUMEN DOBLE
   ======================= #}
{% if costeo or costeo_compras %}
  {% set c1 = costeo %}
  {% set c2 = costeo_compras %}

  <div class="card" style="margin:12px 0;">
    <div class="card-head">
      <h3 style="margin:0;">Resumen comparativo</h3>
      <p class="muted" style="margin:6px 0 0;">
        Izquierda: <b>Usado</b> (respeta manual). Derecha: <b>Solo Compras</b> (ignora manual).
      </p>
    </div>

    <div class="compare">
      <!-- ===== USADO ===== -->
      <div class="cmp">
        <div class="cmp-head">üìå Usado (manual manda)</div>

        {% set precio_actual_1 = (c1.precio_actual if c1 and c1.precio_actual is not none else none) %}
        {% set costo_total_1 = (c1.costo_total if c1 and c1.costo_total is not none else none) %}
        {% set ganancia_actual_1 = none %}
        {% set margen_actual_1 = none %}
        {% if precio_actual_1 and precio_actual_1 > 0 and costo_total_1 is not none %}
          {% set ganancia_actual_1 = (precio_actual_1 - costo_total_1) %}
          {% set margen_actual_1 = ((ganancia_actual_1 / precio_actual_1) * 100) %}
        {% endif %}

        <div class="cmp-grid">
          <div class="box">
            <div class="k">Costo insumos</div>
            <div class="v">{{ c1 and ("$%.2f"|format(c1.costo_insumos or 0)) or "‚Äî" }}</div>
          </div>
          <div class="box">
            <div class="k">Operativos (75%)</div>
            <div class="v">{{ c1 and ("$%.2f"|format(c1.costo_operativo or 0)) or "‚Äî" }}</div>
          </div>
          <div class="box">
            <div class="k">Costo total</div>
            <div class="v">{{ c1 and ("$%.2f"|format(c1.costo_total or 0)) or "‚Äî" }}</div>
          </div>
          <div class="box">
            <div class="k">Precio sugerido</div>
            <div class="v"><b>{{ c1 and ("$%.2f"|format(c1.precio_sugerido or 0)) or "‚Äî" }}</b></div>
          </div>

          <div class="box">
            <div class="k">Ganancia sugerida</div>
            <div class="v">{{ c1 and ("$%.2f"|format(c1.ganancia_sugerida or 0)) or "‚Äî" }}</div>
            <div class="sub">
              <div class="k2">Ganancia con precio actual</div>
              {% if ganancia_actual_1 is not none %}
                <div class="v2"><b>${{ "%.2f"|format(ganancia_actual_1) }}</b> <span class="muted">({{ "%.2f"|format(margen_actual_1) }}%)</span></div>
              {% else %}
                <div class="v2 muted">‚Äî</div>
              {% endif %}
            </div>
          </div>

          <div class="box">
            <div class="k">Precio actual</div>
            <div class="v">
              {% if precio_actual_1 %}${{ "%.2f"|format(precio_actual_1) }}{% else %}<span class="muted">‚Äî</span>{% endif %}
            </div>

            {% if c1 and c1.insumos_sin_precio is defined and c1.insumos_sin_precio and c1.insumos_sin_precio > 0 %}
              <div class="pill pill-warn" style="margin-top:8px;">‚ö†Ô∏è Incompleto ({{ c1.insumos_sin_precio }})</div>
            {% else %}
              <div class="pill pill-ok" style="margin-top:8px;">‚úÖ OK</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- ===== COMPRAS ===== -->
      <div class="cmp">
        <div class="cmp-head">üßæ Solo compras</div>

        {% set precio_actual_2 = (c2.precio_actual if c2 and c2.precio_actual is not none else none) %}
        {% set costo_total_2 = (c2.costo_total if c2 and c2.costo_total is not none else none) %}
        {% set ganancia_actual_2 = none %}
        {% set margen_actual_2 = none %}
        {% if precio_actual_2 and precio_actual_2 > 0 and costo_total_2 is not none %}
          {% set ganancia_actual_2 = (precio_actual_2 - costo_total_2) %}
          {% set margen_actual_2 = ((ganancia_actual_2 / precio_actual_2) * 100) %}
        {% endif %}

        <div class="cmp-grid">
          <div class="box">
            <div class="k">Costo insumos</div>
            <div class="v">{{ c2 and ("$%.2f"|format(c2.costo_insumos or 0)) or "‚Äî" }}</div>
          </div>
          <div class="box">
            <div class="k">Operativos (75%)</div>
            <div class="v">{{ c2 and ("$%.2f"|format(c2.costo_operativo or 0)) or "‚Äî" }}</div>
          </div>
          <div class="box">
            <div class="k">Costo total</div>
            <div class="v">{{ c2 and ("$%.2f"|format(c2.costo_total or 0)) or "‚Äî" }}</div>
          </div>
          <div class="box">
            <div class="k">Precio sugerido</div>
            <div class="v"><b>{{ c2 and ("$%.2f"|format(c2.precio_sugerido or 0)) or "‚Äî" }}</b></div>
          </div>

          <div class="box">
            <div class="k">Ganancia sugerida</div>
            <div class="v">{{ c2 and ("$%.2f"|format(c2.ganancia_sugerida or 0)) or "‚Äî" }}</div>
            <div class="sub">
              <div class="k2">Ganancia con precio actual</div>
              {% if ganancia_actual_2 is not none %}
                <div class="v2"><b>${{ "%.2f"|format(ganancia_actual_2) }}</b> <span class="muted">({{ "%.2f"|format(margen_actual_2) }}%)</span></div>
              {% else %}
                <div class="v2 muted">‚Äî</div>
              {% endif %}
            </div>
          </div>

          <div class="box">
            <div class="k">Precio actual</div>
            <div class="v">
              {% if precio_actual_2 %}${{ "%.2f"|format(precio_actual_2) }}{% else %}<span class="muted">‚Äî</span>{% endif %}
            </div>

            {% if c2 and c2.insumos_sin_precio is defined and c2.insumos_sin_precio and c2.insumos_sin_precio > 0 %}
              <div class="pill pill-warn" style="margin-top:8px;">‚ö†Ô∏è Incompleto ({{ c2.insumos_sin_precio }})</div>
            {% else %}
              <div class="pill pill-ok" style="margin-top:8px;">‚úÖ OK</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <small class="muted" style="display:block; margin-top:10px;">
      ‚ÄúUsado‚Äù respeta manual; ‚ÄúSolo compras‚Äù ignora manual y usa el costo vigente de compras.
    </small>
  </div>

  <style>
    .compare{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .cmp{border:1px solid #eee;border-radius:14px;padding:12px}
    .cmp-head{font-weight:700;margin-bottom:10px}
    .cmp-grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
    .box{border:1px solid #eee;border-radius:12px;padding:10px}
    .box .k{font-size:12px;opacity:.75}
    .box .v{font-size:18px;margin-top:6px}
    .box .sub{margin-top:10px;padding-top:10px;border-top:1px dashed #eee}
    .box .k2{font-size:12px;opacity:.75}
    .box .v2{margin-top:6px}
    @media (max-width: 1100px){
      .compare{grid-template-columns:1fr}
      .cmp-grid{grid-template-columns:1fr}
    }
  </style>
{% endif %}

{# =========================================================
   NUEVO: PROTE√çNAS POR PLATILLO (INVENTARIO)
   No toca el POS. Esto solo llena recetas_proteina.
   ========================================================= #}
<div class="card" style="padding:12px; margin:12px 0;">
  <h3 style="margin:0 0 10px;">ü•© Prote√≠nas por platillo (inventario)</h3>
  <p class="muted" style="margin:0 0 12px;">
    Define cu√°nta prote√≠na se descuenta cuando en el POS seleccionas Pollo/Arrachera/etc.
  </p>

  <form method="post"
        action="{{ url_for('costeo.receta_proteina_guardar', platillo_id=platillo.id) }}"
        class="add-row"
        style="grid-template-columns: 1.2fr 0.6fr 0.8fr; align-items:end;">

    <div>
      <label class="lbl">Prote√≠na</label>
      <select name="proteina_id" class="inp" required>
        <option value="">‚Äî Selecciona ‚Äî</option>
        {% for p in proteinas %}
          <option value="{{ p.id }}">{{ p.nombre }}</option>
        {% endfor %}
      </select>
      <div class="muted" style="margin-top:6px;font-size:12px;">
        Se toma autom√°ticamente el insumo ligado en <b>proteinas.insumo_id</b>.
      </div>
    </div>

    <div>
      <label class="lbl">Cantidad</label>
      <input name="cantidad_base" type="number" step="0.01" min="0.01"
             class="inp" placeholder="Ej. 100" required>
      <div class="muted" style="margin-top:6px;font-size:12px;">
        Tu BD es <b>decimal(10,2)</b>.
      </div>
    </div>

    <div class="add-actions" style="justify-content:flex-start;">
      <button type="submit" class="btn btn-primary">Guardar</button>
    </div>
  </form>

  <div class="table-wrap" style="margin-top:12px;">
    <table class="table">
      <thead>
        <tr>
          <th>Prote√≠na</th>
          <th style="width:160px;">Cantidad</th>
          <th style="width:90px;">Unidad</th>
          <th style="width:110px;">Quitar</th>
        </tr>
      </thead>
      <tbody>
        {% if receta_proteinas and receta_proteinas|length %}
          {% for rp in receta_proteinas %}
            <tr>
              <td><b>{{ rp.proteina_nombre }}</b></td>
              <td>{{ rp.cantidad_base }}</td>
              <td>{{ rp.unidad_base or '‚Äî' }}</td>
              <td>
                <form method="post"
                      action="{{ url_for('costeo.receta_proteina_borrar', platillo_id=platillo.id, proteina_id=rp.proteina_id) }}">
                  <button type="submit" class="btn btn-danger">üóë</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="4" class="muted">A√∫n no hay prote√≠nas configuradas para este platillo.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{# =======================
   FORM RECETA (misma tabla editable)
   ======================= #}
<form method="post" id="recetaForm">

  <div class="card" style="padding:12px; margin:12px 0;">
    <h3 style="margin:0 0 10px;">Agregar ingrediente</h3>

    <div class="add-row">
      <div>
        <label class="lbl">Insumo</label>
        <select id="addInsumo" class="inp">
          <option value="">‚Äî Selecciona ‚Äî</option>
          {% for i in insumos %}
            <option
              value="{{ i.id }}"
              data-nombre="{{ i.nombre }}"
              data-unidad="{{ i.unidad_base }}"
              data-merma="{{ i.merma_pct }}"
              data-compra="{{ i.costo_unitario if i.costo_unitario is not none else '' }}"
            >
              {{ i.nombre }} ({{ i.unidad_base }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="lbl">Cantidad</label>
        <input id="addCantidad" type="number" step="0.01" class="inp" placeholder="Ej. 100">
      </div>

      <div>
        <label class="lbl">$ Manual (opcional)</label>
        <input id="addPrecioManual" type="number" step="0.0001" class="inp" placeholder="$/unidad base">
      </div>

      <div class="add-actions">
        <label class="chk">
          <input id="addUsarManual" type="checkbox">
          <span>Usar manual</span>
        </label>

        <button type="button" class="btn btn-primary" onclick="agregarInsumo()">
          ‚ûï Agregar
        </button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px; font-size:13px;">
      Tip: si marcas ‚ÄúUsar manual‚Äù pero dejas vac√≠o el precio, se guardar√° usando compras.
    </div>
  </div>

  <div class="card" style="padding:12px; margin:12px 0;">
    <h3 style="margin:0 0 10px;">Ingredientes</h3>

    <div class="table-wrap">
      <table class="table" id="recetaTable">
        <thead>
          <tr>
            <th>Insumo</th>
            <th style="width:120px;">Cantidad</th>
            <th style="width:70px;">Unidad</th>
            <th style="width:150px;">$ Manual</th>
            <th style="width:90px;">Usar</th>
            <th style="width:140px;">$ Compras</th>
            <th style="width:140px;">$ Usado</th>
            <th style="width:140px;">Subtotal</th>
            <th style="width:110px;">Quitar</th>
          </tr>
        </thead>

        <tbody id="recetaBody">
          {% for r in receta %}
          <tr class="{% if r.costo_unitario_usado is none %}row-warn{% endif %}">
            <td>
              <b>{{ r.insumo_nombre }}</b>
              {% if r.merma_pct and r.merma_pct != 0 %}
                <div class="muted" style="font-size:12px;">Merma: {{ r.merma_pct }}%</div>
              {% endif %}
              {% if r.costo_unitario_usado is none %}
                <div class="warn-text"><b>SIN PRECIO</b> (pon manual o registra compra)</div>
              {% endif %}
            </td>

            <td style="display:none;">
              <input type="hidden" name="insumo_id[]" value="{{ r.insumo_id }}">
            </td>

            <td>
              <input type="number" step="0.01" name="cantidad_base[]" value="{{ r.cantidad_base }}" class="inp-sm">
            </td>

            <td>{{ r.unidad_base }}</td>

            <td>
              <input type="number" step="0.0001" name="precio_manual[]"
                     value="{{ r.precio_manual if r.precio_manual is not none else '' }}"
                     placeholder="$/{{ r.unidad_base }}"
                     class="inp-sm">
            </td>

            <td style="text-align:center;">
              <input type="hidden" name="usa_precio_manual[]" value="{{ '1' if r.usa_precio_manual else '0' }}">
              <input type="checkbox"
                     {% if r.usa_precio_manual %}checked{% endif %}
                     onchange="this.previousElementSibling.value = this.checked ? '1' : '0';">
            </td>

            <td>{{ r.costo_unitario_compra if r.costo_unitario_compra is not none else '‚Äî' }}</td>
            <td>{{ r.costo_unitario_usado if r.costo_unitario_usado is not none else '‚Äî' }}</td>
            <td>{{ r.subtotal if r.subtotal is not none else '‚Äî' }}</td>

            <td>
              <button type="button" class="btn btn-danger" onclick="quitarFila(this)">üóë</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

  <div class="footer-actions">
    <button type="submit" class="btn btn-primary">Guardar receta</button>
    <a href="{{ url_for('costeo.recetas_index') }}" class="btn btn-secondary">Cancelar</a>
  </div>

</form>

<style>
  .page-head{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:16px}
  .page-actions{display:flex;gap:10px;flex-wrap:wrap}

  .card{background:#fff;border:1px solid #e7e7e7;border-radius:14px;padding:16px}
  .card-head h3{margin:0}
  .muted{opacity:.7}
  .warn-text{font-size:12px;color:#b00020;margin-top:4px}

  .table-wrap{overflow:auto;margin-top:10px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:12px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle;white-space:nowrap}
  .row-warn td{background:#fff8f8}

  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;text-decoration:none;border:1px solid #ddd;background:#fff;cursor:pointer}
  .btn-primary{background:#111;color:#fff;border-color:#111}
  .btn-secondary{background:#f6f6f6;color:#111}
  .btn-danger{background:#fff3f3;color:#b00020;border-color:#f0b4b4;padding:8px 10px}

  .lbl{display:block;font-size:12px;opacity:.75;margin-bottom:6px}
  .inp{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px}
  .inp-sm{width:110px;padding:8px 10px;border:1px solid #ddd;border-radius:10px}

  .add-row{display:grid;grid-template-columns: 1.6fr 0.6fr 0.8fr 0.8fr; gap:12px; align-items:end}
  .add-actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}

  .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #ddd;width:max-content}
  .pill-ok{background:#f3fff3;border-color:#bfe8bf}
  .pill-warn{background:#fff4f4;border-color:#f0b4b4}

  .footer-actions{display:flex;gap:10px;align-items:center;margin-top:14px}
</style>

<script>
  function quitarFila(btn) {
    const tr = btn.closest('tr');
    if (tr) tr.remove();
  }

  function agregarInsumo() {
    const sel = document.getElementById('addInsumo');
    const cant = document.getElementById('addCantidad');
    const pm = document.getElementById('addPrecioManual');
    const um = document.getElementById('addUsarManual');

    const insumoId = sel.value;
    const opt = sel.options[sel.selectedIndex];

    if (!insumoId) { alert('Selecciona un insumo.'); return; }

    const cantidad = (cant.value || '').trim();
    if (!cantidad || Number(cantidad) <= 0) { alert('Cantidad inv√°lida.'); return; }

    const exists = Array.from(document.querySelectorAll('input[name="insumo_id[]"]'))
      .some(i => i.value === insumoId);
    if (exists) { alert('Ese insumo ya est√° en la receta.'); return; }

    const nombre = opt.getAttribute('data-nombre') || 'Insumo';
    const unidad = opt.getAttribute('data-unidad') || '';
    const merma = opt.getAttribute('data-merma') || '';
    const compra = opt.getAttribute('data-compra') || '';

    const precioManual = (pm.value || '').trim();
    const usarManual = (um.checked && precioManual !== '') ? '1' : '0';

    const body = document.getElementById('recetaBody');
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>
        <b>${escapeHtml(nombre)}</b>
        ${merma && merma !== '0.00' ? `<div class="muted" style="font-size:12px;">Merma: ${escapeHtml(merma)}%</div>` : ``}
      </td>

      <td style="display:none;">
        <input type="hidden" name="insumo_id[]" value="${escapeAttr(insumoId)}">
      </td>

      <td>
        <input type="number" step="0.01" name="cantidad_base[]" value="${escapeAttr(cantidad)}" class="inp-sm">
      </td>

      <td>${escapeHtml(unidad)}</td>

      <td>
        <input type="number" step="0.0001" name="precio_manual[]" value="${escapeAttr(precioManual)}"
               placeholder="$/${escapeHtml(unidad)}" class="inp-sm">
      </td>

      <td style="text-align:center;">
        <input type="hidden" name="usa_precio_manual[]" value="${usarManual}">
        <input type="checkbox" ${usarManual === '1' ? 'checked' : ''} onchange="this.previousElementSibling.value = this.checked ? '1' : '0';">
      </td>

      <td>${compra ? escapeHtml(compra) : '‚Äî'}</td>
      <td>‚Äî</td>
      <td>‚Äî</td>

      <td>
        <button type="button" class="btn btn-danger" onclick="quitarFila(this)">üóë</button>
      </td>
    `;

    body.appendChild(tr);

    // limpia
    cant.value = '';
    pm.value = '';
    um.checked = false;
    sel.value = '';
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, function(m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }
  function escapeAttr(s) { return escapeHtml(s); }
</script>

{% endblock %}
