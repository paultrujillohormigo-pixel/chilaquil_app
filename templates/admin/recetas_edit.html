<div style="display:flex; gap:10px; margin-bottom:12px;">
  <a class="btn btn-secondary" href="{{ url_for('costeo.recetas_index') }}">‚Üê Recetas</a>
  <a class="btn btn-secondary" href="{{ url_for('costeo.costeo_index') }}">üìä Costeo</a>
</div>

<h2>Receta: {{ platillo.nombre }}</h2>

<form method="post">
  <table class="table">
  <thead>
    <tr>
      <th>Insumo</th>
      <th>Cantidad</th>
      <th>Unidad</th>
      <th>Costo unitario</th>
      <th>Subtotal</th>
      <th></th>
    </tr>
  </thead>

  <tbody id="rows">
    {% for r in receta %}
    <tr>
      <td>
        <select name="insumo_id[]" class="insumoSelect" onchange="onRowChange(this)">
          {% for i in insumos %}
            <option value="{{ i.id }}" {% if i.id == r.insumo_id %}selected{% endif %}>
              {{ i.nombre }}
            </option>
          {% endfor %}
        </select>
      </td>

      <td>
        <input type="number" step="0.01" min="0"
               name="cantidad_base[]"
               value="{{ r.cantidad_base }}"
               oninput="onQtyChange(this)">
      </td>

      <td class="unidad">{{ r.unidad_base }}</td>

      <td class="costo_unitario">
        {% if r.costo_unitario is not none %}
{% if r.get('costo_unitario') is not none %}
  ${{ "%.4f"|format(r.get('costo_unitario')) }}
{% else %}
  <span class="muted">Sin costo</span>
{% endif %}
        {% else %}
          <span class="muted">Sin costo</span>
        {% endif %}
      </td>

      <td class="subtotal">
        {% if r.subtotal is not none %}
          ${{ "%.2f"|format(r.subtotal) }}
        {% else %}
          <span class="muted">‚Äî</span>
        {% endif %}
      </td>

      <td><button type="button" class="btn" onclick="removeRow(this)">Quitar</button></td>
    </tr>
    {% endfor %}
  </tbody>
</table>


  <button type="button" class="btn" onclick="addRow()">+ Agregar ingrediente</button>
  <button type="submit" class="btn btn-primary">Guardar receta</button>
</form>

<hr>

<h3>Desglose (autom√°tico)</h3>
{% if costeo %}
  <ul>
    <li><strong>Costo insumos:</strong> ${{ costeo.costo_insumos }}</li>
    <li><strong>Costos operativos (75%):</strong> ${{ costeo.costo_operativo }}</li>
    <li><strong>Costo total:</strong> ${{ costeo.costo_total }}</li>
    <li><strong>Ganancia sugerida (margen 80%):</strong> ${{ costeo.ganancia_sugerida }}</li>
    <li><strong>Precio sugerido:</strong> ${{ costeo.precio_sugerido }}</li>
    {% if costeo.precio_actual %}
      <li><strong>Precio actual:</strong> ${{ costeo.precio_actual }}</li>
    {% endif %}
  </ul>
{% else %}
  <p>No hay costeo a√∫n (falta costo vigente de alg√∫n insumo o receta vac√≠a).</p>
{% endif %}

<script>
  // insumos incluye: id, nombre, unidad_base, merma_pct, costo_unitario
  const INSUMOS = {{ insumos|tojson }};
  const insumoMap = new Map(INSUMOS.map(i => [String(i.id), i]));

  function money4(x){ return `$${Number(x).toFixed(4)}`; }
  function money2(x){ return `$${Number(x).toFixed(2)}`; }

  function recalcRow(tr){
    const sel = tr.querySelector(".insumoSelect");
    const qtyInput = tr.querySelector("input[name='cantidad_base[]']");
    const unidadTd = tr.querySelector(".unidad");
    const costoTd = tr.querySelector(".costo_unitario");
    const subtotalTd = tr.querySelector(".subtotal");

    const insumo = insumoMap.get(String(sel.value));
    const qty = Number(qtyInput.value || 0);

    // unidad
    unidadTd.textContent = insumo?.unidad_base || "‚Äî";

    // costo unitario
    const cu = insumo?.costo_unitario;
    if (cu === null || cu === undefined) {
      costoTd.innerHTML = `<span class="muted">Sin costo</span>`;
      subtotalTd.innerHTML = `<span class="muted">‚Äî</span>`;
      return;
    }

    costoTd.textContent = money4(cu);

    // subtotal con merma
    const merma = Number(insumo?.merma_pct || 0);
    const subtotal = qty * Number(cu) * (1 + merma/100);
    subtotalTd.textContent = money2(subtotal);
  }

  function onRowChange(selectEl){
    recalcRow(selectEl.closest("tr"));
  }

  function onQtyChange(inputEl){
    recalcRow(inputEl.closest("tr"));
  }

  function removeRow(btn){
    btn.closest("tr").remove();
  }

  function addRow(){
    const tbody = document.getElementById("rows");
    const tr = document.createElement("tr");

    const options = INSUMOS.map(i => `<option value="${i.id}">${i.nombre}</option>`).join("");

    tr.innerHTML = `
      <td>
        <select name="insumo_id[]" class="insumoSelect" onchange="onRowChange(this)">
          ${options}
        </select>
      </td>
      <td>
        <input type="number" step="0.01" min="0" name="cantidad_base[]" value="" oninput="onQtyChange(this)">
      </td>
      <td class="unidad">‚Äî</td>
      <td class="costo_unitario"><span class="muted">‚Äî</span></td>
      <td class="subtotal"><span class="muted">‚Äî</span></td>
      <td><button type="button" class="btn" onclick="removeRow(this)">Quitar</button></td>
    `;

    tbody.appendChild(tr);
    recalcRow(tr);
  }

  // recalcular todo al cargar (por si ya hay datos)
  document.querySelectorAll("#rows tr").forEach(tr => recalcRow(tr));
</script>
