{% extends "base.html" %}
{% block content %}

<header class="page-head">
  <div>
    <h2 class="page-title">ðŸ§¾ Compras</h2>
    <p class="page-subtitle">
      Si activas <strong>Sumar stock</strong>, captura la compra en <strong>unidad base</strong> del insumo.
    </p>
  </div>
</header>

<div class="layout-2col">

  <!-- ================== FORM ================== -->
  <section class="card">
    <div class="card-head">
      <h3>Registrar compra</h3>
      <span class="hint">Campos obligatorios marcados</span>
    </div>

    <form method="post" id="compraForm" class="form">

      <!-- ================= MODO ================= -->
      <div class="section">
        <div class="section-title">Modo</div>

        <div class="toggles">
          <label class="toggle">
            <input type="checkbox" id="esInsumo" name="es_insumo" value="1">
            <span class="toggle-ui"></span>
            <span class="toggle-text">
              <strong>Sumar stock</strong>
              <small>Usa unidad base del insumo</small>
            </span>
          </label>

          <label class="toggle" id="toggleOtroLabel">
            <input type="checkbox" id="esOtro" name="es_otro" value="1">
            <span class="toggle-ui"></span>
            <span class="toggle-text">
              <strong>Otro (no estÃ¡ en la lista)</strong>
              <small>No suma stock</small>
            </span>
          </label>
        </div>
      </div>

      <!-- ================= DATOS ================= -->
      <div class="section">
        <div class="section-title">Datos generales</div>

        <div class="grid">
          <div class="field">
            <label>Fecha *</label>
            <input type="date" name="fecha" required>
          </div>

          <div class="field">
            <label>Lugar *</label>
            <input type="text" name="lugar" required>
          </div>

          <div class="field">
            <label>Tipo *</label>
            <select name="tipo_costo" required>
              <option value="insumos">Insumos</option>
              <option value="operativo">Operativo</option>
              <option value="servicios">Servicios</option>
              <option value="renta">Renta</option>
              <option value="nomina">NÃ³mina</option>
              <option value="mantenimiento">Mantenimiento</option>
              <option value="otro">Otro</option>
            </select>
          </div>

          <div class="field">
            <label>Costo total *</label>
            <input type="number" name="costo" step="0.01" min="0" required>
          </div>

          <div class="field span-2">
            <label>Nota</label>
            <input type="text" name="nota">
          </div>
        </div>
      </div>

      <!-- ================= CONCEPTO ================= -->
      <div class="section">
        <div class="section-title">Concepto / Insumo</div>

        <div class="grid">
          <div class="field">
            <label>Insumo</label>
            <select name="insumo_id" id="insumoSelect">
              <option value="">â€” Selecciona â€”</option>
              {% for ins in insumos %}
                <option value="{{ ins.id }}" data-unidad="{{ ins.unidad_base }}">
                  {{ ins.nombre }} ({{ ins.unidad_base }})
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="field" id="otroWrap" style="display:none;">
            <label>Nombre *</label>
            <input type="text" id="otroTexto" autocomplete="off">
          </div>
        </div>

        <input type="hidden" name="concepto" id="concepto">
      </div>

      <!-- ================= TEXTO LIBRE ================= -->
      <div class="section" id="textoFields">
        <div class="section-title">Cantidad (texto libre)</div>

        <div class="grid">
          <div class="field">
            <label>Cantidad *</label>
            <input type="number" name="cantidad" id="cantidadTxt" step="0.01" min="0.0001">
          </div>

          <div class="field">
            <label>Unidad *</label>
            <input type="text" name="unidad" id="unidadTxt">
          </div>
        </div>
      </div>

      <!-- ================= STOCK ================= -->
      <div class="section" id="stockPanel" style="display:none;">
        <div class="section-title">Entrada a inventario</div>

        <div class="grid">
          <div class="field">
            <label>Cantidad base *</label>
            <input type="number" name="cantidad_base" id="cantidadBase" step="0.01" min="0">
          </div>

          <div class="field">
            <label>Unidad base</label>
            <input type="text" name="unidad_base" id="unidadBase" readonly>
          </div>

          <div class="field">
            <label>Costo unitario</label>
            <input type="number" name="costo_unitario" id="costoUnitario" step="0.0001" readonly>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn-primary">ðŸ’¾ Guardar compra</button>
      </div>

    </form>
  </section>

</div>

<script>
function qs(id){ return document.getElementById(id); }
function norm(s){ return (s||"").toString().trim(); }

function setReq(el, req){
  if(!el) return;
  el.required = req;
  el.disabled = !req;
}

function setEnabled(el, enabled){
  if(!el) return;
  el.disabled = !enabled;
}

function setUnidadBase(){
  const sel = qs("insumoSelect");
  const opt = sel.options[sel.selectedIndex];
  qs("unidadBase").value = opt ? opt.dataset.unidad || "" : "";
}

function calcUnit(){
  const costo = parseFloat(document.querySelector("input[name='costo']").value||0);
  const cant = parseFloat(qs("cantidadBase").value||0);
  qs("costoUnitario").value = cant>0 ? (costo/cant).toFixed(4) : "";
}

function syncConcepto(){
  if(qs("esOtro").checked){
    qs("concepto").value = norm(qs("otroTexto").value) || "Otro";
  } else {
    const sel = qs("insumoSelect");
    const opt = sel.options[sel.selectedIndex];
    qs("concepto").value = opt ? opt.textContent.trim() : "Compra";
  }
}

function toggle(){
  const sumar = qs("esInsumo").checked;
  const otro = qs("esOtro").checked;
  const insumo = norm(qs("insumoSelect").value);

  if(sumar && otro){
    qs("esOtro").checked=false;
  }

  qs("otroWrap").style.display = qs("esOtro").checked?"block":"none";
  qs("textoFields").style.display = sumar?"none":"block";

  const showStock = sumar && insumo;
  qs("stockPanel").style.display = showStock?"block":"none";

  setReq(qs("cantidadTxt"), !sumar);
  setReq(qs("unidadTxt"), !sumar);
  setReq(qs("cantidadBase"), showStock);

  setEnabled(qs("unidadBase"), showStock);
  setEnabled(qs("costoUnitario"), showStock);

  if(showStock){
    setUnidadBase();
    calcUnit();
  }

  syncConcepto();
}

document.addEventListener("DOMContentLoaded",()=>{
  toggle();

  qs("esInsumo").addEventListener("change",toggle);
  qs("esOtro").addEventListener("change",toggle);
  qs("insumoSelect").addEventListener("change",toggle);
  qs("otroTexto").addEventListener("input",syncConcepto);
  qs("cantidadBase").addEventListener("input",calcUnit);
  document.querySelector("input[name='costo']").addEventListener("input",calcUnit);
});
</script>

{% endblock %}
