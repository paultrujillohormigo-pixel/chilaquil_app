{% extends "base.html" %}
{% block content %}

<h2>Productos</h2>

<!-- ================== FORM NUEVO PRODUCTO ================== -->
<form method="post"
      style="display:grid; gap:12px; max-width:900px; margin-bottom:22px;">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">

        <div>
            <label>Nombre</label>
            <input type="text" name="nombre" required style="width:100%;">
        </div>

        <div>
            <label>CategorÃ­a</label>
            <input type="text"
                   name="categoria"
                   placeholder="chilaquiles, tamal, bebida..."
                   required
                   style="width:100%;">
        </div>

            <div>
                          <label>Costo</label>
                          <input type="number"
                                 name="costo"
                                 id="costoInput"
                                 step="0.01"
                                 required
                                 style="width:100%;">
                        </div>
                        
                        <div style="grid-column: 1 / -1;">
                          <label>Platillo (para receta / inventario)</label>
                          <select name="platillo_id"
                                  id="platilloSelect"
                                  style="width:100%;">
                            <option value="">â€” Sin platillo (costo manual) â€”</option>
                            {% for pl in platillos %}
                              <option value="{{ pl.id }}"
                                      data-costo="{{ pl.costo_base }}">
                                {{ pl.nombre }} â€” ${{ "%.2f"|format(pl.costo_base) }}
                              </option>
                            {% endfor %}
                          </select>
                        
                          <small style="opacity:.7;">
                            Si eliges un platillo, el costo se toma automÃ¡ticamente de su receta.
                          </small>
            </div>


        <div>
            <label>Precio</label>
            <input type="number" name="precio" step="0.01" required style="width:100%;">
        </div>

        <div style="grid-column: 1 / -1;">
            <label>Platillo (para receta / inventario)</label>
            <select name="platillo_id" style="width:100%;">
                <option value="">â€” Sin platillo (NO descuenta inventario) â€”</option>
                {% for pl in platillos %}
                    <option value="{{ pl.id }}">{{ pl.nombre }}</option>
                {% endfor %}
            </select>
            <small style="opacity:.7;">
                Si lo relacionas, este producto descontarÃ¡ inventario al cerrar pedido
                usando recetas y recetas_proteina.
            </small>
        </div>
    </div>

    <div style="display:flex; justify-content:flex-end;">
        <button type="submit" class="btn-primary">âž• Agregar producto</button>
    </div>
</form>

<hr style="margin:18px 0; opacity:.25;">

<!-- ================== TABLA PRODUCTOS ================== -->
<table border="1"
       cellpadding="8"
       cellspacing="0"
       style="width:100%; border-collapse:collapse;">

    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>CategorÃ­a</th>
            <th>Costo</th>
            <th>Precio</th>
            <th>Platillo ligado</th>
            <th style="width:120px;">Acciones</th>
        </tr>
    </thead>

    <tbody>
        {% for p in productos %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.categoria }}</td>
            <td>{{ p.costo | money }}</td>
            <td>{{ p.precio | money }}</td>
            <td>
                {% if p.platillo_id %}
                    {{ p.platillo_nombre }}
                    <small style="opacity:.6;">(#{{ p.platillo_id }})</small>
                {% else %}
                    <span style="opacity:.5;">â€”</span>
                {% endif %}
            </td>
            <td style="text-align:center;">
                <form method="post"
                      action="{{ url_for('eliminar_producto', producto_id=p.id) }}"
                      onsubmit="return confirm('Â¿Eliminar este producto? No se borrarÃ¡ el historial de pedidos.');">
                    <button type="submit"
                            style="background:#c0392b;
                                   color:#fff;
                                   border:0;
                                   padding:6px 10px;
                                   border-radius:6px;
                                   cursor:pointer;">
                        ðŸ—‘ Eliminar
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script>
const platilloSelect = document.getElementById("platilloSelect");
const costoInput = document.getElementById("costoInput");

platilloSelect.addEventListener("change", () => {
  const opt = platilloSelect.options[platilloSelect.selectedIndex];
  const costo = opt.getAttribute("data-costo");

  if (costo && platilloSelect.value !== "") {
    costoInput.value = Number(costo).toFixed(2);
    costoInput.readOnly = true;
    costoInput.style.background = "#f5f5f5";
  } else {
    costoInput.value = "";
    costoInput.readOnly = false;
    costoInput.style.background = "#fff";
  }
});
</script>

{% endblock %}
